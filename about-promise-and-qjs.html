<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png" />
    <title> imCuttle </title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
<div id="root">
    <div class="wrap" data-reactroot="" data-reactid="1" data-react-checksum="-1367426153"><header data-reactid="2"><a class="logo-link" href="/" data-reactid="3"><img src="/favicon.png" data-reactid="4"/></a><ul class="nav nav-list" data-reactid="5"><li class="nav-list-item" data-reactid="6"><a class="nav-list-link" href="/posts/1" data-reactid="7">Posts</a></li></ul></header><main data-reactid="8"><div class="post" data-reactid="9"><article class="post-block" data-reactid="10"><h1 class="post-title" data-reactid="11">「ECMAScript6」Promise介绍与nodejs实践运用(q.js)</h1><div class="post-info" data-reactid="12"><time datetime="2016-05-01T09:56:42+00:00" data-reactid="13">May 1, 2016 9:56 AM</time></div></article><div class="post-content" data-reactid="14"><article data-reactid="15"><h1 id="介绍" data-reactid="16"><a href="#%E4%BB%8B%E7%BB%8D" aria-hidden="true" data-reactid="17"><span class="icon icon-link" data-reactid="18"></span></a><!-- react-text: 19 -->介绍<!-- /react-text --></h1><!-- react-text: 20 -->
<!-- /react-text --><p data-reactid="21"><!-- react-text: 22 -->看了网上许多介绍 <!-- /react-text --><code data-reactid="23">Promise</code><!-- react-text: 24 --> 的文章，终于知道 <!-- /react-text --><code data-reactid="25">Promise</code><!-- react-text: 26 --> 是什么，干什么的了。
首先需要指出的是，<!-- /react-text --><strong data-reactid="27">promise是es6提出的新标准之一</strong><!-- react-text: 28 -->，那么提出这个标准是用来做什么的呢？<!-- /react-text --></p><!-- react-text: 29 -->
<!-- /react-text --><!-- react-text: 30 -->
<!-- /react-text --><p data-reactid="31"><!-- react-text: 32 -->写过js代码的童鞋一定知道，异步回调函数是js的一大特点，那么异步回调函数带来的问题是什么呢？会造成函数嵌套过多，不宜于后期代码的维护，许多的<!-- /react-text --><code data-reactid="33">({})</code><!-- react-text: 34 -->也容易把我们搞得晕头转向。那么promise便是用来解决该问题。
那么es6提出这个标准，那么就得有人按照这个标准来实现吧，于是百家争鸣，出现许多库(以便在非浏览器环境下使用)，在这我介绍 <!-- /react-text --><code data-reactid="35">q.js</code><!-- react-text: 36 -->.
<!-- /react-text --><a href="https://github.com/kriskowal/q" data-reactid="37"><code data-reactid="38">q.js</code><!-- react-text: 39 --> github地址<!-- /react-text --></a></p><!-- react-text: 40 -->
<!-- /react-text --><h1 id="使用" data-reactid="41"><a href="#%E4%BD%BF%E7%94%A8" aria-hidden="true" data-reactid="42"><span class="icon icon-link" data-reactid="43"></span></a><!-- react-text: 44 -->使用<!-- /react-text --></h1><!-- react-text: 45 -->
<!-- /react-text --><ul data-reactid="46"><!-- react-text: 47 -->
<!-- /react-text --><li data-reactid="48"><!-- react-text: 49 -->安装<!-- /react-text --><code data-reactid="50">q.js</code><!-- react-text: 51 -->
npm install q<!-- /react-text --></li><!-- react-text: 52 -->
<!-- /react-text --><li data-reactid="53">使用</li><!-- react-text: 54 -->
<!-- /react-text --></ul><!-- react-text: 55 -->
<!-- /react-text --><ol data-reactid="56"><!-- react-text: 57 -->
<!-- /react-text --><li data-reactid="58"><!-- react-text: 59 -->使用<!-- /react-text --><code data-reactid="60">Q.nfcall</code></li><!-- react-text: 61 -->
<!-- /react-text --></ol><!-- react-text: 62 -->
<!-- /react-text --><pre data-reactid="63"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="64"><span class="hljs-keyword" data-reactid="65">var</span><!-- react-text: 66 --> fs = <!-- /react-text --><span class="hljs-built_in" data-reactid="67">require</span><!-- react-text: 68 -->(<!-- /react-text --><span class="hljs-string" data-reactid="69">&#x27;fs&#x27;</span><!-- react-text: 70 -->),
    Q   = <!-- /react-text --><span class="hljs-built_in" data-reactid="71">require</span><!-- react-text: 72 -->(<!-- /react-text --><span class="hljs-string" data-reactid="73">&#x27;q&#x27;</span><!-- react-text: 74 -->);
<!-- /react-text --><span class="hljs-keyword" data-reactid="75">var</span><!-- react-text: 76 --> promise = Q.nfcall(fs.readFile,<!-- /react-text --><span class="hljs-string" data-reactid="77">&#x27;run.js&#x27;</span><!-- react-text: 78 -->);
promise.then(<!-- /react-text --><span class="hljs-function" data-reactid="79"><span class="hljs-keyword" data-reactid="80">function</span><!-- react-text: 81 -->(<!-- /react-text --><span class="hljs-params" data-reactid="82">data</span><!-- react-text: 83 -->)<!-- /react-text --></span><!-- react-text: 84 -->{
        <!-- /react-text --><span class="hljs-built_in" data-reactid="85">console</span><!-- react-text: 86 -->.log(data);
    },<!-- /react-text --><span class="hljs-function" data-reactid="87"><span class="hljs-keyword" data-reactid="88">function</span><!-- react-text: 89 -->(<!-- /react-text --><span class="hljs-params" data-reactid="90">err</span><!-- react-text: 91 -->)<!-- /react-text --></span><!-- react-text: 92 -->{
        <!-- /react-text --><span class="hljs-built_in" data-reactid="93">console</span><!-- react-text: 94 -->.err(err);
    });<!-- /react-text --></code></pre><!-- react-text: 95 -->
<!-- /react-text --><pre data-reactid="96"><code data-query="{}" data-lang="data-lang" data-reactid="97">或者可以简写为下面
    promise.then(console.log,console.err);
</code></pre><!-- react-text: 98 -->
<!-- /react-text --><ol start="2" data-reactid="99"><!-- react-text: 100 -->
<!-- /react-text --><li data-reactid="101"><!-- react-text: 102 -->使用<!-- /react-text --><code data-reactid="103">Q.deferd</code></li><!-- react-text: 104 -->
<!-- /react-text --></ol><!-- react-text: 105 -->
<!-- /react-text --><pre data-reactid="106"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="107"><span class="hljs-keyword" data-reactid="108">var</span><!-- react-text: 109 --> preadFile = <!-- /react-text --><span class="hljs-function" data-reactid="110"><span class="hljs-keyword" data-reactid="111">function</span><!-- react-text: 112 -->(<!-- /react-text --><span class="hljs-params" data-reactid="113">file</span><!-- react-text: 114 -->)<!-- /react-text --></span><!-- react-text: 115 -->{
    <!-- /react-text --><span class="hljs-keyword" data-reactid="116">var</span><!-- react-text: 117 --> deferred = Q.defer();
    fs.readFile(file,  <!-- /react-text --><span class="hljs-function" data-reactid="118"><span class="hljs-keyword" data-reactid="119">function</span><!-- react-text: 120 --> (<!-- /react-text --><span class="hljs-params" data-reactid="121">error, text</span><!-- react-text: 122 -->) <!-- /react-text --></span><!-- react-text: 123 -->{
        <!-- /react-text --><span class="hljs-keyword" data-reactid="124">if</span><!-- react-text: 125 --> (error) {
            deferred.reject(<!-- /react-text --><span class="hljs-keyword" data-reactid="126">new</span><!-- react-text: 127 --> <!-- /react-text --><span class="hljs-built_in" data-reactid="128">Error</span><!-- react-text: 129 -->(error));
        } <!-- /react-text --><span class="hljs-keyword" data-reactid="130">else</span><!-- react-text: 131 --> {
            deferred.resolve(text);
        }
    });
    <!-- /react-text --><span class="hljs-keyword" data-reactid="132">return</span><!-- react-text: 133 --> deferred.promise;
};
preadFile(<!-- /react-text --><span class="hljs-string" data-reactid="134">&#x27;run.js&#x27;</span><!-- react-text: 135 -->).then(<!-- /react-text --><span class="hljs-built_in" data-reactid="136">console</span><!-- react-text: 137 -->.log,<!-- /react-text --><span class="hljs-built_in" data-reactid="138">console</span><!-- react-text: 139 -->.err);<!-- /react-text --></code></pre><!-- react-text: 140 -->
<!-- /react-text --><ol start="3" data-reactid="141"><!-- react-text: 142 -->
<!-- /react-text --><li data-reactid="143"><!-- react-text: 144 -->还可以用<!-- /react-text --><code data-reactid="145">Q.all</code><!-- react-text: 146 -->实现<!-- /react-text --><strong data-reactid="147">同步方式</strong></li><!-- react-text: 148 -->
<!-- /react-text --></ol><!-- react-text: 149 -->
<!-- /react-text --><pre data-reactid="150"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="151"><span class="hljs-keyword" data-reactid="152">var</span><!-- react-text: 153 --> promise = Q.all([Q.nfcall(fs.readFile,<!-- /react-text --><span class="hljs-string" data-reactid="154">&#x27;run.js&#x27;</span><!-- react-text: 155 -->),preadFile(<!-- /react-text --><span class="hljs-string" data-reactid="156">&#x27;event.js&#x27;</span><!-- react-text: 157 -->),preadFile(<!-- /react-text --><span class="hljs-string" data-reactid="158">&#x27;nofound.js&#x27;</span><!-- react-text: 159 -->)]);
promise.then(<!-- /react-text --><span class="hljs-function" data-reactid="160"><span class="hljs-keyword" data-reactid="161">function</span><!-- react-text: 162 -->(<!-- /react-text --><span class="hljs-params" data-reactid="163">data</span><!-- react-text: 164 -->)<!-- /react-text --></span><!-- react-text: 165 -->{<!-- /react-text --><span class="hljs-built_in" data-reactid="166">console</span><!-- react-text: 167 -->.log(data.toString())},<!-- /react-text --><span class="hljs-built_in" data-reactid="168">console</span><!-- react-text: 169 -->.error);<!-- /react-text --></code></pre><!-- react-text: 170 -->
<!-- /react-text --><pre data-reactid="171"><code data-query="{}" data-lang="data-lang" data-reactid="172">因为`nofound.js`不存在所以会抛出异常，其他文件即使存在也不会正确执行.
</code></pre><!-- react-text: 173 -->
<!-- /react-text --><ol start="4" data-reactid="174"><!-- react-text: 175 -->
<!-- /react-text --><li data-reactid="176"><!-- react-text: 177 -->多层嵌套<!-- /react-text --><strong data-reactid="178">异步方式</strong></li><!-- react-text: 179 -->
<!-- /react-text --></ol><!-- react-text: 180 -->
<!-- /react-text --><pre data-reactid="181"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="182"><span class="hljs-keyword" data-reactid="183">var</span><!-- react-text: 184 --> preadFile = <!-- /react-text --><span class="hljs-function" data-reactid="185"><span class="hljs-keyword" data-reactid="186">function</span><!-- react-text: 187 -->(<!-- /react-text --><span class="hljs-params" data-reactid="188">file</span><!-- react-text: 189 -->)<!-- /react-text --></span><!-- react-text: 190 -->{
    <!-- /react-text --><span class="hljs-keyword" data-reactid="191">var</span><!-- react-text: 192 --> deferred = Q.defer();
    fs.readFile(file,  <!-- /react-text --><span class="hljs-function" data-reactid="193"><span class="hljs-keyword" data-reactid="194">function</span><!-- react-text: 195 --> (<!-- /react-text --><span class="hljs-params" data-reactid="196">error, text</span><!-- react-text: 197 -->) <!-- /react-text --></span><!-- react-text: 198 -->{
        <!-- /react-text --><span class="hljs-keyword" data-reactid="199">if</span><!-- react-text: 200 --> (error) {
            deferred.reject(<!-- /react-text --><span class="hljs-keyword" data-reactid="201">new</span><!-- react-text: 202 --> <!-- /react-text --><span class="hljs-built_in" data-reactid="203">Error</span><!-- react-text: 204 -->(error));
        } <!-- /react-text --><span class="hljs-keyword" data-reactid="205">else</span><!-- react-text: 206 --> {
            deferred.resolve({<!-- /react-text --><span class="hljs-attr" data-reactid="207">data</span><!-- react-text: 208 -->:text,<!-- /react-text --><span class="hljs-attr" data-reactid="209">file</span><!-- react-text: 210 -->:file});
        }
    });
    <!-- /react-text --><span class="hljs-keyword" data-reactid="211">return</span><!-- react-text: 212 --> deferred.promise;
};

preadFile(<!-- /react-text --><span class="hljs-string" data-reactid="213">&#x27;run.js&#x27;</span><!-- react-text: 214 -->)
    .then(<!-- /react-text --><span class="hljs-function" data-reactid="215"><span class="hljs-keyword" data-reactid="216">function</span><!-- react-text: 217 --> (<!-- /react-text --><span class="hljs-params" data-reactid="218">d</span><!-- react-text: 219 -->) <!-- /react-text --></span><!-- react-text: 220 -->{
        <!-- /react-text --><span class="hljs-built_in" data-reactid="221">console</span><!-- react-text: 222 -->.log(d);
        <!-- /react-text --><span class="hljs-keyword" data-reactid="223">return</span><!-- react-text: 224 --> d.file+<!-- /react-text --><span class="hljs-string" data-reactid="225">&#x27;xx&#x27;</span><!-- react-text: 226 -->;
    })
    .then(preadFile)  <!-- /react-text --><span class="hljs-comment" data-reactid="227">//上面return d.file 传递到preadFile中</span><!-- react-text: 228 -->
    .then(<!-- /react-text --><span class="hljs-function" data-reactid="229"><span class="hljs-keyword" data-reactid="230">function</span><!-- react-text: 231 --> (<!-- /react-text --><span class="hljs-params" data-reactid="232">d</span><!-- react-text: 233 -->) <!-- /react-text --></span><!-- react-text: 234 -->{
        <!-- /react-text --><span class="hljs-built_in" data-reactid="235">console</span><!-- react-text: 236 -->.log(d);
        <!-- /react-text --><span class="hljs-keyword" data-reactid="237">return</span><!-- react-text: 238 --> d.file;
    })
    .catch(<!-- /react-text --><span class="hljs-function" data-reactid="239"><span class="hljs-keyword" data-reactid="240">function</span><!-- react-text: 241 --> (<!-- /react-text --><span class="hljs-params" data-reactid="242">e</span><!-- react-text: 243 -->) <!-- /react-text --></span><!-- react-text: 244 -->{
        <!-- /react-text --><span class="hljs-built_in" data-reactid="245">console</span><!-- react-text: 246 -->.log(e);
    }).done(<!-- /react-text --><span class="hljs-function" data-reactid="247"><span class="hljs-keyword" data-reactid="248">function</span><!-- react-text: 249 --> (<!-- /react-text --><span class="hljs-params" data-reactid="250">e</span><!-- react-text: 251 -->) <!-- /react-text --></span><!-- react-text: 252 -->{<!-- /react-text --><span class="hljs-comment" data-reactid="253">//最后一个then return的参数</span><!-- react-text: 254 -->
        <!-- /react-text --><span class="hljs-built_in" data-reactid="255">console</span><!-- react-text: 256 -->.log(e);
    });<!-- /react-text --></code></pre><!-- react-text: 257 -->
<!-- /react-text --><pre data-reactid="258"><code data-query="{}" data-lang="data-lang" data-reactid="259">上面的代码`run.js`将会正确输出，但是因为不存在`run.jsxx`文件所以会捕获错误，但不影响`run.js`的输出。
</code></pre><!-- react-text: 260 -->
<!-- /react-text --><h1 id="尾声" data-reactid="261"><a href="#%E5%B0%BE%E5%A3%B0" aria-hidden="true" data-reactid="262"><span class="icon icon-link" data-reactid="263"></span></a><!-- react-text: 264 -->尾声<!-- /react-text --></h1><!-- react-text: 265 -->
<!-- /react-text --><p data-reactid="266"><!-- react-text: 267 -->更多的用法参考<!-- /react-text --><a href="https://github.com/kriskowal/q" data-reactid="268"><code data-reactid="269">q.js</code><!-- react-text: 270 --> github地址<!-- /react-text --></a><!-- react-text: 271 -->
原来我以前一直使用的 <!-- /react-text --><code data-reactid="272">$.ajax({}).fail().done()</code><!-- react-text: 273 --> 正是promise方式的一种。<!-- /react-text --></p><!-- react-text: 274 -->
<!-- /react-text --></article></div><div class="gitment-container" data-reactid="275"></div><div class="paginator" data-reactid="276"><a title="「转」为什么V8 JavaScript引擎这么快" class="prev" href="/why-v8-so-fast" data-reactid="277">Prev</a><a title="「项目拾遗」谈谈websocket" class="next" href="/talk-about-websocket" data-reactid="278">Next</a></div></div></main><footer data-reactid="279"><div class="copyright" data-reactid="280"><p data-reactid="281"><!-- react-text: 282 -->© 2017. Powered By <!-- /react-text --><a href="https://github.com/picidaejs/picidae" data-reactid="283">Picidae</a></p></div></footer></div>
</div>
<script src="/PICIDAE_COMMON.js"></script>
<script src="/PICIDAE_ENTRY.js"></script>
</body>
</html>