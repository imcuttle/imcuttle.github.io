<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png" />
    <title> React在线编辑国际化文本 - Grass </title>
    <link rel="stylesheet" href="/style.css">
    <style>
        #music {
            position: fixed;
            top: 10px;
            left: 10px;
        }
    </style>
</head>
<body>
<div id="root">
    <div class="wrap" data-reactroot="" data-reactid="1" data-react-checksum="-2018564848"><header data-reactid="2"><a class="logo-link" href="/" data-reactid="3"><img src="/favicon.png" data-reactid="4"/></a><ul class="nav nav-list" data-reactid="5"><li class="nav-list-item" data-reactid="6"><a class="nav-list-link" href="/posts/1" data-reactid="7">Posts</a></li></ul></header><main data-reactid="8"><div class="post" data-reactid="9"><article class="post-block" data-reactid="10"><h1 class="post-title" data-reactid="11">React在线编辑国际化文本</h1><div class="post-info" data-reactid="12"><time datetime="2018-06-22T14:33:11+00:00" data-reactid="13">Jun 22, 2018 2:33 PM</time></div></article><div class="post-content" data-reactid="14"><article data-reactid="15"><style data-reactid="16">.transformer-react-render{border:1px dashed #959da5;border-radius:5px;display:block}.transformer-react-render-container&gt;pre{max-height:400px;transition:all .2s ease}.transformer-react-render-container&gt;pre.focused{max-height:none;box-shadow:0 0 6px rgba(0,0,0,.2)}</style><p data-reactid="17"><!-- react-text: 18 -->今天给大家介绍一个轻量但神奇的国际化库<!-- /react-text --><a href="https://github.com/imcuttle/tiny-i18n" data-reactid="19">tiny-i18n</a></p><p data-reactid="20"><!-- react-text: 21 -->在我们的项目日益庞大的情况下，国际化的字典愈变愈大，国际化文本的维护是一个问题；<!-- /react-text --><br data-reactid="22"/><!-- react-text: 23 -->有时候修改一个字段，查找就花费了很大的时间功夫。 这个时候 tiny-i18n 中的 <!-- /react-text --><a href="https://github.com/imcuttle/tiny-i18n/tree/master/packages/react-live" data-reactid="24">@tiny-i18n/react-live</a><!-- react-text: 25 --> 就可以发挥它的力量了，可以帮助我们在线可视化修改、新增国际化字段。<!-- /react-text --></p><h2 id="效果" data-reactid="26"><a href="#%E6%95%88%E6%9E%9C" aria-hidden="true" data-reactid="27"><span class="icon icon-link" data-reactid="28"></span></a><!-- react-text: 29 -->效果<!-- /react-text --></h2><ul data-reactid="30"><li data-reactid="31"><p data-reactid="32"><!-- react-text: 33 -->视频效果：<!-- /react-text --><a href="http://obu9je6ng.bkt.clouddn.com/Jietu20180622-102135-HD.mp4" data-reactid="34">http://obu9je6ng.bkt.clouddn.com/Jietu20180622-102135-HD.mp4</a></p></li><li data-reactid="35"><p data-reactid="36"><a href="https://imcuttle.github.io/tiny-i18n/" data-reactid="37">DEMO</a><!-- react-text: 38 --> - 更新后，字典存储至 localStorage 中<!-- /react-text --></p></li></ul><h2 id="体验在线编辑" data-reactid="39"><a href="#%E4%BD%93%E9%AA%8C%E5%9C%A8%E7%BA%BF%E7%BC%96%E8%BE%91" aria-hidden="true" data-reactid="40"><span class="icon icon-link" data-reactid="41"></span></a><!-- react-text: 42 -->体验在线编辑<!-- /react-text --></h2><iframe src="https://codesandbox.io/embed/kpow6rnnr" style="width:100%;height:500px;border:0px;border-radius:4px;overflow:hidden;" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin" data-reactid="43"></iframe><h2 id="实现原理" data-reactid="44"><a href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86" aria-hidden="true" data-reactid="45"><span class="icon icon-link" data-reactid="46"></span></a><!-- react-text: 47 -->实现原理<!-- /react-text --></h2><p data-reactid="48"><!-- react-text: 49 -->对 i18n 转换方法进行包装，转换成包含特殊字符（包裹）的字符串；同时对 <!-- /react-text --><code data-reactid="50">React.createElement</code><!-- react-text: 51 --> 方法进行包装，检测出包含特殊字符（包裹）的字符串，这时候就会被认为是国际化的文本，这个时候再去注入一些而外的交互逻辑。<!-- /react-text --></p><p data-reactid="52">以 codesandbox DEMO 为例，在下面这段 React 视图代码中：</p><pre data-reactid="53"><code class="hljs language-jsx" data-query="{}" data-lang="jsx" data-reactid="54"><span class="hljs-class" data-reactid="55"><span class="hljs-keyword" data-reactid="56">class</span><!-- react-text: 57 --> <!-- /react-text --><span class="hljs-title" data-reactid="58">App</span><!-- react-text: 59 --> <!-- /react-text --><span class="hljs-keyword" data-reactid="60">extends</span><!-- react-text: 61 --> <!-- /react-text --><span class="hljs-title" data-reactid="62">React</span><!-- react-text: 63 -->.<!-- /react-text --><span class="hljs-title" data-reactid="64">Component</span><!-- react-text: 65 --> <!-- /react-text --></span><!-- react-text: 66 -->{
  changeLang = <!-- /react-text --><span class="hljs-function" data-reactid="67"><span class="hljs-params" data-reactid="68">lang</span><!-- react-text: 69 --> =&gt;<!-- /react-text --></span><!-- react-text: 70 --> {
    <!-- /react-text --><span class="hljs-keyword" data-reactid="71">this</span><!-- react-text: 72 -->.context.i18n.setLanguage(lang);
  };
  render() {
    <!-- /react-text --><span class="hljs-keyword" data-reactid="73">return</span><!-- react-text: 74 --> (
      <!-- /react-text --><span class="xml" data-reactid="75"><span class="hljs-tag" data-reactid="76"><!-- react-text: 77 -->&lt;<!-- /react-text --><span class="hljs-name" data-reactid="78">div</span><!-- react-text: 79 --> <!-- /react-text --><span class="hljs-attr" data-reactid="80">className</span><!-- react-text: 81 -->=<!-- /react-text --><span class="hljs-string" data-reactid="82">&quot;App&quot;</span><!-- react-text: 83 -->&gt;<!-- /react-text --></span><!-- react-text: 84 -->
        <!-- /react-text --></span><!-- react-text: 85 -->&lt;h1&gt;{_i(&quot;tpl.sayhello&quot;, _i(&quot;name&quot;))}&lt;/h1&gt;<!-- /react-text --><span class="xml" data-reactid="86">
        </span><!-- react-text: 87 -->&lt;h2 title={_i(&quot;content.text&quot;)}&gt;{_i(&quot;content.text&quot;)}&lt;/h2&gt;<!-- /react-text --><span class="xml" data-reactid="88">
        </span><!-- react-text: 89 -->&lt;a href=&quot;/?react-live&quot;&gt;Open react-live mode&lt;/a&gt;<!-- /react-text --><span class="xml" data-reactid="90">
        </span><!-- react-text: 91 -->&lt;div&gt;
          &lt;h3&gt;
            {_i(&quot;label.current.lang&quot;)}: {i.getCurrentLanguage()}
          &lt;/h3&gt;
          {i.getLanguages().map(lang =&gt; (
            &lt;button key={lang} onClick={this.changeLang.bind(this, lang)}&gt;
              {lang}
            &lt;/button&gt;
          ))}
        &lt;/div&gt;<!-- /react-text --><span class="xml" data-reactid="92"><!-- react-text: 93 -->
      <!-- /react-text --><span class="hljs-tag" data-reactid="94"><!-- react-text: 95 -->&lt;/<!-- /react-text --><span class="hljs-name" data-reactid="96">div</span><!-- react-text: 97 -->&gt;<!-- /react-text --></span></span><!-- react-text: 98 -->
    );
  }
}<!-- /react-text --></code></pre><p data-reactid="99"><!-- react-text: 100 -->如下图，为国际化文本正常渲染的 DOM 结构：<!-- /react-text --><br data-reactid="101"/><img src="https://i.loli.net/2018/06/23/5b2ddc31d501a.png" data-reactid="102"/></p><p data-reactid="103"><!-- react-text: 104 -->并无什么异样，只不过是 <!-- /react-text --><code data-reactid="105">_i(...)</code><!-- react-text: 106 --> 方法转换为对应语言的译文字符串。<!-- /react-text --></p><p data-reactid="107"><!-- react-text: 108 -->那么在开启 React-Live 功能之后呢？（点击 <!-- /react-text --><code data-reactid="109">Open react-live mode</code><!-- react-text: 110 -->）<!-- /react-text --></p><p data-reactid="111">react-live 模式加载了下面的脚本</p><pre data-reactid="112"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="113"><span class="hljs-keyword" data-reactid="114">if</span><!-- react-text: 115 --> (location.search === <!-- /react-text --><span class="hljs-string" data-reactid="116">&quot;?react-live&quot;</span><!-- react-text: 117 -->) {
  <!-- /react-text --><span class="hljs-built_in" data-reactid="118">require</span><!-- react-text: 119 -->(<!-- /react-text --><span class="hljs-string" data-reactid="120">&quot;@tiny-i18n/react-live/register&quot;</span><!-- react-text: 121 -->);
  <!-- /react-text --><span class="hljs-built_in" data-reactid="122">require</span><!-- react-text: 123 -->(<!-- /react-text --><span class="hljs-string" data-reactid="124">&quot;@tiny-i18n/react-live/lib/style.css&quot;</span><!-- react-text: 125 -->);
}<!-- /react-text --></code></pre><p data-reactid="126"><!-- react-text: 127 -->视图就神奇地变成了下面所示！ <!-- /react-text --><img src="https://i.loli.net/2018/06/23/5b2ddcbb2d9ec.png" data-reactid="128"/></p><p data-reactid="129">观察 DOM 结构可以看出来，在 “你好呀，大家” 这段国际化文本中，对应代码为：</p><pre data-reactid="130"><code class="hljs language-jsx" data-query="{}" data-lang="jsx" data-reactid="131"><!-- react-text: 132 -->&lt;h1&gt;{_i(<!-- /react-text --><span class="hljs-string" data-reactid="133">&quot;tpl.sayhello&quot;</span><!-- react-text: 134 -->, _i(<!-- /react-text --><span class="hljs-string" data-reactid="135">&quot;name&quot;</span><!-- react-text: 136 -->))}&lt;<!-- /react-text --><span class="hljs-regexp" data-reactid="137">/h1&gt;</span></code></pre><p data-reactid="138">字典数据为</p><pre data-reactid="139"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="140"><!-- react-text: 141 -->i.setDictionary(
  {
    <!-- /react-text --><span class="hljs-string" data-reactid="142">&quot;label.current.lang&quot;</span><!-- react-text: 143 -->: <!-- /react-text --><span class="hljs-string" data-reactid="144">&quot;当前语言&quot;</span><!-- react-text: 145 -->,
    <!-- /react-text --><span class="hljs-string" data-reactid="146">&quot;name&quot;</span><!-- react-text: 147 -->: <!-- /react-text --><span class="hljs-string" data-reactid="148">&quot;大家&quot;</span><!-- react-text: 149 -->,
    <!-- /react-text --><span class="hljs-string" data-reactid="150">&quot;tpl.sayhello&quot;</span><!-- react-text: 151 -->: <!-- /react-text --><span class="hljs-string" data-reactid="152">&quot;你好呀，${1}&quot;</span><!-- react-text: 153 -->,
    <!-- /react-text --><span class="hljs-string" data-reactid="154">&quot;content.text&quot;</span><!-- react-text: 155 -->: <!-- /react-text --><span class="hljs-string" data-reactid="156">&quot;点击下面的链接看看有什么神奇的事情发生吧！&quot;</span><!-- react-text: 157 -->
  },
  <!-- /react-text --><span class="hljs-string" data-reactid="158">&quot;zh-CN&quot;</span><!-- react-text: 159 -->
);<!-- /react-text --></code></pre><ul data-reactid="160"><li data-reactid="161"><p data-reactid="162">未开启 react-live 对应的 HTML:</p><pre data-reactid="163"><code class="hljs language-html" data-query="{}" data-lang="html" data-reactid="164"><span class="hljs-tag" data-reactid="165"><!-- react-text: 166 -->&lt;<!-- /react-text --><span class="hljs-name" data-reactid="167">h1</span><!-- react-text: 168 -->&gt;<!-- /react-text --></span><!-- react-text: 169 -->你好呀，大家<!-- /react-text --><span class="hljs-tag" data-reactid="170"><!-- react-text: 171 -->&lt;/<!-- /react-text --><span class="hljs-name" data-reactid="172">h1</span><!-- react-text: 173 -->&gt;<!-- /react-text --></span></code></pre></li><li data-reactid="174"><p data-reactid="175"><!-- react-text: 176 -->开启后变成： <!-- /react-text --><img src="https://i.loli.net/2018/06/24/5b2f63fb8399c.png" data-reactid="177"/></p></li></ul><p data-reactid="178"><!-- react-text: 179 -->不难发现，react-live 注入了一些额外的数据，并且各字段之间也被奇怪的字符： <!-- /react-text --><code data-reactid="180">&amp;#8203;</code><!-- react-text: 181 --> <!-- /react-text --><code data-reactid="182">&amp;zwnj;</code><!-- react-text: 183 --> 包裹，这两个字符是特殊的不可见字符。通过这两个字符包裹，可以<!-- /react-text --><strong data-reactid="184">找到对应翻译文本在 DOM 中的位置，进而可以进行替换</strong><!-- react-text: 185 -->。<!-- /react-text --></p><p data-reactid="186">但是这两个不可见字符也会带来隐藏的问题，如复制下面“你好”文本</p><p data-reactid="187">你​‌好</p><p data-reactid="188"><!-- react-text: 189 -->看来其中的字符串长度为2，但是实际上却是2<!-- /react-text --><br data-reactid="190"/><img src="https://i.loli.net/2018/06/24/5b2f657f036f8.png" data-reactid="191"/></p><p data-reactid="192"><!-- react-text: 193 -->这是因为上面的文本，实际上为 <!-- /react-text --><code data-reactid="194">你&amp;#8203;&amp;zwnj;好</code><!-- react-text: 195 -->，而中间 2 个字符不可见。<!-- /react-text --></p><h2 id="其他问题" data-reactid="196"><a href="#%E5%85%B6%E4%BB%96%E9%97%AE%E9%A2%98" aria-hidden="true" data-reactid="197"><span class="icon icon-link" data-reactid="198"></span></a><!-- react-text: 199 -->其他问题<!-- /react-text --></h2><p data-reactid="200"><!-- react-text: 201 -->除了上文介绍的不可见字符带来的问题以外，还有如果开启 react-live 模式后，i18n 转换方法输出的字符串将<!-- /react-text --><strong data-reactid="202">不会再是正确的转换文本</strong><!-- react-text: 203 -->；只有通过 React.createElement 方法才能被正确转换为国际化的文本。<!-- /react-text --></p><p data-reactid="204"><!-- react-text: 205 -->所以 <!-- /react-text --><code data-reactid="206">document.title = _i(&#x27;...&#x27;)</code><!-- react-text: 207 --> 这样的语句会有问题； <!-- /react-text --><img src="https://i.loli.net/2018/06/24/5b2f66ee9959b.png" data-reactid="208"/></p><p data-reactid="209"><!-- react-text: 210 -->即使是使用 <!-- /react-text --><a href="https://github.com/gaearon/react-document-title" data-reactid="211">react-document-title</a><!-- react-text: 212 --> 也是会有相同的问题。因为 react-live 只会对 html tag(React.createElement 第一个参数为字符串) 中的国际化文本进行转换。<!-- /react-text --></p></article></div><div class="gitment-container" data-reactid="213"></div><div class="paginator" data-reactid="214"><a title="书写组件 DEMO 的一些方案" class="prev" href="/how-to-write-component-demo" data-reactid="215">Prev</a><a title="如何录制命令行交互？" class="next" href="/how-to-record-command-line" data-reactid="216">Next</a></div></div></main><footer data-reactid="217"><div class="copyright" data-reactid="218"><p data-reactid="219"><!-- react-text: 220 -->© 2017. Powered By <!-- /react-text --><a href="https://github.com/picidaejs/picidae" data-reactid="221">Picidae</a></p></div></footer></div>
</div>
<audio id="music" controls autoplay src="http://www.170mv.com/kw/other.web.ri01.sycdn.kuwo.cn/resource/n3/25/67/3891786006.mp3"></audio>
<script>
  !function () {
    var a = document.getElementById("music")
    a && (a.volume = 1)
  }()
</script>
<script src="/PICIDAE_COMMON.js"></script>
<script src="/PICIDAE_ENTRY.js"></script>
</body>
</html>
