<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png" />
    <title> 本地实时书写 markdown + 同步定位修改节点 - Grass </title>
    <link rel="stylesheet" href="/style.css">
    <style>
        #music {
            position: fixed;
            top: 10px;
            left: 10px;
        }
    </style>
</head>
<body>
<div id="root">
    <div class="wrap" data-reactroot="" data-reactid="1" data-react-checksum="-2022932281"><header data-reactid="2"><a class="logo-link" href="/" data-reactid="3"><img src="/favicon.png" data-reactid="4"/></a><ul class="nav nav-list" data-reactid="5"><li class="nav-list-item" data-reactid="6"><a class="nav-list-link" href="/posts/1" data-reactid="7">Posts</a></li></ul></header><main data-reactid="8"><div class="post" data-reactid="9"><article class="post-block" data-reactid="10"><h1 class="post-title" data-reactid="11">本地实时书写 markdown + 同步定位修改节点</h1><div class="post-info" data-reactid="12"><time datetime="2018-11-05T11:06:45+00:00" data-reactid="13">Nov 5, 2018 11:06 AM</time></div></article><div class="post-content" data-reactid="14"><article data-reactid="15"><style data-reactid="16">.transformer-react-render{border:1px dashed #959da5;border-radius:5px;display:block}.transformer-react-render-container&gt;pre{max-height:400px;transition:all .2s ease}.transformer-react-render-container&gt;pre.focused{max-height:none;box-shadow:0 0 6px rgba(0,0,0,.2)}</style><h2 id="前言" data-reactid="17"><a href="#%E5%89%8D%E8%A8%80" aria-hidden="true" data-reactid="18"><span class="icon icon-link" data-reactid="19"></span></a><!-- react-text: 20 -->前言<!-- /react-text --></h2><p data-reactid="21"><!-- react-text: 22 -->16 年在 SF 中发布了文章 <!-- /react-text --><a href="https://segmentfault.com/a/1190000006260582" data-reactid="23">&quot;探究SegumentFault Markdown编辑器&quot;</a><!-- react-text: 24 -->，目的是仿 SF 线上书写 Markdown 文档的体验：<!-- /react-text --><strong data-reactid="25">高亮定位修改节点</strong></p><p data-reactid="26">在上述文章中的工具已经不再维护（😢代码写太乱），而且是在浏览器中书写 markdown 文本。</p><p data-reactid="27"><!-- react-text: 28 -->于是现在使用全新的思路实现了一个：<!-- /react-text --><strong data-reactid="29">在本地任意编辑器书写 markdown，同时同步定位修改节点</strong><!-- react-text: 30 --> 工具 <!-- /react-text --><a href="https://github.com/imcuttle/live-markd" data-reactid="31">live-markd</a></p><p data-reactid="32"><!-- react-text: 33 -->预览效果如图:<!-- /react-text --><br data-reactid="34"/><img src="https://i.loli.net/2018/11/05/5bdfb82f1239d.gif" data-reactid="35"/></p><h2 id="如何使用" data-reactid="36"><a href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8" aria-hidden="true" data-reactid="37"><span class="icon icon-link" data-reactid="38"></span></a><!-- react-text: 39 -->如何使用<!-- /react-text --></h2><ol data-reactid="40"><li data-reactid="41"><p data-reactid="42">安装 nodejs 环境，如已经有则跳过此步</p></li><li data-reactid="43"><p data-reactid="44"><!-- react-text: 45 -->全局安装 <!-- /react-text --><code data-reactid="46">live-markd</code></p><pre data-reactid="47"><code class="hljs language-bash" data-query="{}" data-lang="bash" data-reactid="48">npm install live-markd -g</code></pre></li><li data-reactid="49"><p data-reactid="50">进入到 markdown 文件目录</p><pre data-reactid="51"><code class="hljs language-bash" data-query="{}" data-lang="bash" data-reactid="52">live-markd path/to/markdown</code></pre></li></ol><h2 id="如何实现" data-reactid="53"><a href="#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0" aria-hidden="true" data-reactid="54"><span class="icon icon-link" data-reactid="55"></span></a><!-- react-text: 56 -->如何实现<!-- /react-text --></h2><h3 id="如何实现修改节点的检测" data-reactid="57"><a href="#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%BF%AE%E6%94%B9%E8%8A%82%E7%82%B9%E7%9A%84%E6%A3%80%E6%B5%8B" aria-hidden="true" data-reactid="58"><span class="icon icon-link" data-reactid="59"></span></a><!-- react-text: 60 -->如何实现修改节点的检测<!-- /react-text --></h3><p data-reactid="61"><!-- react-text: 62 -->使用 <!-- /react-text --><a href="https://github.com/remarkjs/remark" data-reactid="63">remark</a><!-- react-text: 64 --> 解析 markdown，得到 <!-- /react-text --><a href="https://github.com/syntax-tree/mdast" data-reactid="65">markdown 抽象语法树</a></p><p data-reactid="66"><!-- react-text: 67 -->如下例子，现在有两个 markdown 文件 <!-- /react-text --><code data-reactid="68">old.md</code><!-- react-text: 69 --> 和 <!-- /react-text --><code data-reactid="70">new.md</code></p><ul data-reactid="71"><li data-reactid="72"><p data-reactid="73"><code data-reactid="74">old.md</code></p><pre data-reactid="75"><code class="hljs language-markdown" data-query="{}" data-lang="markdown" data-reactid="76"><span class="hljs-section" data-reactid="77"># hi</span><!-- react-text: 78 -->
world<!-- /react-text --></code></pre></li><li data-reactid="79"><p data-reactid="80"><code data-reactid="81">new.md</code></p><pre data-reactid="82"><code class="hljs language-markdown" data-query="{}" data-lang="markdown" data-reactid="83"><span class="hljs-section" data-reactid="84"># hi</span><!-- react-text: 85 -->
world!<!-- /react-text --></code></pre></li></ul><p data-reactid="86"><!-- react-text: 87 -->可以看到 <!-- /react-text --><code data-reactid="88">new.md</code><!-- react-text: 89 --> 相比于 <!-- /react-text --><code data-reactid="90">old.md</code><!-- react-text: 91 --> 最后多了 <!-- /react-text --><code data-reactid="92">!</code></p><p data-reactid="93">进一步的，对比两个 markdown 文本的语法树</p><pre data-reactid="94"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="95"><span class="hljs-comment" data-reactid="96">// old.md</span><!-- react-text: 97 -->
{
  <!-- /react-text --><span class="hljs-attr" data-reactid="98">type</span><!-- react-text: 99 -->: <!-- /react-text --><span class="hljs-string" data-reactid="100">&#x27;root&#x27;</span><!-- react-text: 101 -->,
  <!-- /react-text --><span class="hljs-attr" data-reactid="102">children</span><!-- react-text: 103 -->: [
    {
      <!-- /react-text --><span class="hljs-attr" data-reactid="104">type</span><!-- react-text: 105 -->: <!-- /react-text --><span class="hljs-string" data-reactid="106">&#x27;heading&#x27;</span><!-- react-text: 107 -->,
      <!-- /react-text --><span class="hljs-attr" data-reactid="108">depth</span><!-- react-text: 109 -->: <!-- /react-text --><span class="hljs-number" data-reactid="110">1</span><!-- react-text: 111 -->,
      <!-- /react-text --><span class="hljs-attr" data-reactid="112">children</span><!-- react-text: 113 -->: [{
        <!-- /react-text --><span class="hljs-attr" data-reactid="114">type</span><!-- react-text: 115 -->: <!-- /react-text --><span class="hljs-string" data-reactid="116">&#x27;paragraph&#x27;</span><!-- react-text: 117 -->,
        <!-- /react-text --><span class="hljs-attr" data-reactid="118">children</span><!-- react-text: 119 -->: [{ <!-- /react-text --><span class="hljs-attr" data-reactid="120">type</span><!-- react-text: 121 -->: <!-- /react-text --><span class="hljs-string" data-reactid="122">&#x27;text&#x27;</span><!-- react-text: 123 -->, <!-- /react-text --><span class="hljs-attr" data-reactid="124">value</span><!-- react-text: 125 -->: <!-- /react-text --><span class="hljs-string" data-reactid="126">&#x27;world&#x27;</span><!-- react-text: 127 --> }]
      }]
    }
  ]
}

<!-- /react-text --><span class="hljs-comment" data-reactid="128">// new.md</span><!-- react-text: 129 -->
{
  <!-- /react-text --><span class="hljs-attr" data-reactid="130">type</span><!-- react-text: 131 -->: <!-- /react-text --><span class="hljs-string" data-reactid="132">&#x27;root&#x27;</span><!-- react-text: 133 -->,
  <!-- /react-text --><span class="hljs-attr" data-reactid="134">children</span><!-- react-text: 135 -->: [
    {
      <!-- /react-text --><span class="hljs-attr" data-reactid="136">type</span><!-- react-text: 137 -->: <!-- /react-text --><span class="hljs-string" data-reactid="138">&#x27;heading&#x27;</span><!-- react-text: 139 -->,
      <!-- /react-text --><span class="hljs-attr" data-reactid="140">depth</span><!-- react-text: 141 -->: <!-- /react-text --><span class="hljs-number" data-reactid="142">1</span><!-- react-text: 143 -->,
      <!-- /react-text --><span class="hljs-attr" data-reactid="144">children</span><!-- react-text: 145 -->: [{
        <!-- /react-text --><span class="hljs-attr" data-reactid="146">type</span><!-- react-text: 147 -->: <!-- /react-text --><span class="hljs-string" data-reactid="148">&#x27;paragraph&#x27;</span><!-- react-text: 149 -->,
        <!-- /react-text --><span class="hljs-attr" data-reactid="150">children</span><!-- react-text: 151 -->: [{ <!-- /react-text --><span class="hljs-attr" data-reactid="152">type</span><!-- react-text: 153 -->: <!-- /react-text --><span class="hljs-string" data-reactid="154">&#x27;text&#x27;</span><!-- react-text: 155 -->, <!-- /react-text --><span class="hljs-attr" data-reactid="156">value</span><!-- react-text: 157 -->: <!-- /react-text --><span class="hljs-string" data-reactid="158">&#x27;world!&#x27;</span><!-- react-text: 159 --> }]
      }]
    }
  ]
}<!-- /react-text --></code></pre><p data-reactid="160">然后分别对两个树结构进行 DFS，依次对比节点，判断出第一个不同的节点即可，最后对修改的节点注入 class，最后转换成带 class 的 html</p><pre data-reactid="161"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="162"><!-- react-text: 163 -->{
  <!-- /react-text --><span class="hljs-attr" data-reactid="164">hProperties</span><!-- react-text: 165 -->: {
    <!-- /react-text --><span class="hljs-attr" data-reactid="166">className</span><!-- react-text: 167 -->: [<!-- /react-text --><span class="hljs-string" data-reactid="168">&#x27;detected-updated&#x27;</span><!-- react-text: 169 -->]
  },
  <!-- /react-text --><span class="hljs-attr" data-reactid="170">type</span><!-- react-text: 171 -->: <!-- /react-text --><span class="hljs-string" data-reactid="172">&#x27;paragraph&#x27;</span><!-- react-text: 173 -->,
  <!-- /react-text --><span class="hljs-attr" data-reactid="174">children</span><!-- react-text: 175 -->: [{ <!-- /react-text --><span class="hljs-attr" data-reactid="176">type</span><!-- react-text: 177 -->: <!-- /react-text --><span class="hljs-string" data-reactid="178">&#x27;text&#x27;</span><!-- react-text: 179 -->, <!-- /react-text --><span class="hljs-attr" data-reactid="180">value</span><!-- react-text: 181 -->: <!-- /react-text --><span class="hljs-string" data-reactid="182">&#x27;world!&#x27;</span><!-- react-text: 183 --> }]
}<!-- /react-text --></code></pre><pre data-reactid="184"><code class="hljs language-html" data-query="{}" data-lang="html" data-reactid="185"><span class="hljs-tag" data-reactid="186"><!-- react-text: 187 -->&lt;<!-- /react-text --><span class="hljs-name" data-reactid="188">h1</span><!-- react-text: 189 -->&gt;<!-- /react-text --></span><!-- react-text: 190 -->hi<!-- /react-text --><span class="hljs-tag" data-reactid="191"><!-- react-text: 192 -->&lt;/<!-- /react-text --><span class="hljs-name" data-reactid="193">h1</span><!-- react-text: 194 -->&gt;<!-- /react-text --></span><!-- react-text: 195 -->
<!-- /react-text --><span class="hljs-tag" data-reactid="196"><!-- react-text: 197 -->&lt;<!-- /react-text --><span class="hljs-name" data-reactid="198">p</span><!-- react-text: 199 --> <!-- /react-text --><span class="hljs-attr" data-reactid="200">class</span><!-- react-text: 201 -->=<!-- /react-text --><span class="hljs-string" data-reactid="202">&quot;detected-updated&quot;</span><!-- react-text: 203 -->&gt;<!-- /react-text --></span><!-- react-text: 204 -->world!<!-- /react-text --><span class="hljs-tag" data-reactid="205"><!-- react-text: 206 -->&lt;/<!-- /react-text --><span class="hljs-name" data-reactid="207">p</span><!-- react-text: 208 -->&gt;<!-- /react-text --></span></code></pre><p data-reactid="209"><!-- react-text: 210 -->当然，以上 markdown 比对工作由 <!-- /react-text --><a href="https://github.com/imcuttle/detect-one-changed" data-reactid="211">detect-one-changed</a><!-- react-text: 212 --> 完成<!-- /react-text --></p><h3 id="如何实现数据推送" data-reactid="213"><a href="#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E6%8E%A8%E9%80%81" aria-hidden="true" data-reactid="214"><span class="icon icon-link" data-reactid="215"></span></a><!-- react-text: 216 -->如何实现数据推送<!-- /react-text --></h3><p data-reactid="217"><!-- react-text: 218 -->live-markd 使用 服务器推送（EventStream）来实现客户端和服务端的长连接，就如 <!-- /react-text --><a href="https://github.com/webpack-contrib/webpack-hot-middleware" data-reactid="219">webpack-hot-middleware</a><!-- react-text: 220 --> 实现，只有单向的服务端向客户端的数据推送。同时为了让服务器知晓客户端是否还存在，还具有每隔 30s 的心跳检测，用于及时回收服务端资源。<!-- /react-text --></p><p data-reactid="221"><img src="https://i.loli.net/2018/11/05/5bdfd3b887888.png" data-reactid="222"/></p><h4 id="客户端" data-reactid="223"><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF" aria-hidden="true" data-reactid="224"><span class="icon icon-link" data-reactid="225"></span></a><!-- react-text: 226 -->客户端<!-- /react-text --></h4><p data-reactid="227">在客户端只需要接受服务器推送数据即可</p><pre data-reactid="228"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="229"><span class="hljs-comment" data-reactid="230">// 建立连接</span><!-- react-text: 231 -->
<!-- /react-text --><span class="hljs-keyword" data-reactid="232">const</span><!-- react-text: 233 --> source = <!-- /react-text --><span class="hljs-keyword" data-reactid="234">new</span><!-- react-text: 235 --> EventSource(location.pathname + <!-- /react-text --><span class="hljs-string" data-reactid="236">&#x27;?sse=on&#x27;</span><!-- react-text: 237 -->)
source.addEventListener(<!-- /react-text --><span class="hljs-string" data-reactid="238">&#x27;message&#x27;</span><!-- react-text: 239 -->, <!-- /react-text --><span class="hljs-function" data-reactid="240"><span class="hljs-keyword" data-reactid="241">function</span><!-- react-text: 242 -->(<!-- /react-text --><span class="hljs-params" data-reactid="243">ev</span><!-- react-text: 244 -->) <!-- /react-text --></span><!-- react-text: 245 -->{
  <!-- /react-text --><span class="hljs-keyword" data-reactid="246">let</span><!-- react-text: 247 --> data = {}
  <!-- /react-text --><span class="hljs-keyword" data-reactid="248">try</span><!-- react-text: 249 --> {
    data = <!-- /react-text --><span class="hljs-built_in" data-reactid="250">JSON</span><!-- react-text: 251 -->.parse(ev.data)
  } <!-- /react-text --><span class="hljs-keyword" data-reactid="252">catch</span><!-- react-text: 253 --> (e) {}

  <!-- /react-text --><span class="hljs-keyword" data-reactid="254">if</span><!-- react-text: 255 --> (data.type === <!-- /react-text --><span class="hljs-string" data-reactid="256">&#x27;change&#x27;</span><!-- react-text: 257 -->) {
    <!-- /react-text --><span class="hljs-built_in" data-reactid="258">document</span><!-- react-text: 259 -->.querySelector(<!-- /react-text --><span class="hljs-string" data-reactid="260">&#x27;.markdown-body&#x27;</span><!-- react-text: 261 -->).innerHTML = data.value
    <!-- /react-text --><span class="hljs-keyword" data-reactid="262">const</span><!-- react-text: 263 --> node = <!-- /react-text --><span class="hljs-built_in" data-reactid="264">document</span><!-- react-text: 265 -->.querySelector(<!-- /react-text --><span class="hljs-string" data-reactid="266">&#x27;.markdown-body .detected-updated&#x27;</span><!-- react-text: 267 -->)
    <!-- /react-text --><span class="hljs-keyword" data-reactid="268">if</span><!-- react-text: 269 --> (node) {
      <!-- /react-text --><span class="hljs-comment" data-reactid="270">// 定位</span><!-- react-text: 271 -->
      node.scrollIntoView({ <!-- /react-text --><span class="hljs-attr" data-reactid="272">behavior</span><!-- react-text: 273 -->: <!-- /react-text --><span class="hljs-string" data-reactid="274">&#x27;smooth&#x27;</span><!-- react-text: 275 --> })
    }
  }
})<!-- /react-text --></code></pre><p data-reactid="276">同时注入高亮样式：</p><pre data-reactid="277"><code class="hljs language-css" data-query="{}" data-lang="css" data-reactid="278"><!-- react-text: 279 -->@<!-- /react-text --><span class="hljs-keyword" data-reactid="280">keyframes</span><!-- react-text: 281 --> bling {
  <!-- /react-text --><span class="hljs-selector-tag" data-reactid="282">from</span><!-- react-text: 283 --> {
    <!-- /react-text --><span class="hljs-attribute" data-reactid="284">background-color</span><!-- react-text: 285 -->: <!-- /react-text --><span class="hljs-number" data-reactid="286">#d9edf7</span><!-- react-text: 287 -->;
  }
  <!-- /react-text --><span class="hljs-selector-tag" data-reactid="288">to</span><!-- react-text: 289 --> {
    <!-- /react-text --><span class="hljs-attribute" data-reactid="290">background-color</span><!-- react-text: 291 -->: <!-- /react-text --><span class="hljs-number" data-reactid="292">#d9edf7</span><!-- react-text: 293 -->;
  }
}
<!-- /react-text --><span class="hljs-selector-class" data-reactid="294">.markdown-body</span><!-- react-text: 295 --> <!-- /react-text --><span class="hljs-selector-class" data-reactid="296">.detected-updated</span><!-- react-text: 297 --> {
  <!-- /react-text --><span class="hljs-attribute" data-reactid="298">animation</span><!-- react-text: 299 -->: bling <!-- /react-text --><span class="hljs-number" data-reactid="300">2.5s</span><!-- react-text: 301 --> <!-- /react-text --><span class="hljs-number" data-reactid="302">1</span><!-- react-text: 303 -->;
}<!-- /react-text --></code></pre><h2 id="最后" data-reactid="304"><a href="#%E6%9C%80%E5%90%8E" aria-hidden="true" data-reactid="305"><span class="icon icon-link" data-reactid="306"></span></a><!-- react-text: 307 -->最后<!-- /react-text --></h2><p data-reactid="308"><!-- react-text: 309 -->在 <!-- /react-text --><a href="https://github.com/mdx-js/mdx" data-reactid="310">mdx</a><!-- react-text: 311 --> 生态中，该功能也能够被使用，详见 <!-- /react-text --><a href="https://github.com/imcuttle/detect-one-changed" data-reactid="312">detect-one-changed</a></p><p data-reactid="313"><!-- react-text: 314 -->在 <!-- /react-text --><a href="https://github.com/jxnblk/mdx-go/pull/22" data-reactid="315">mdx-go</a><!-- react-text: 316 --> 和 <!-- /react-text --><a href="https://github.com/pedronauck/docz/pull/433" data-reactid="317">docz</a><!-- react-text: 318 --> 中都已经提供 PR 以引入该书写体验！等待作者的回复。<!-- /react-text --></p><p data-reactid="319">欢迎大家 Star 👍！</p><ul data-reactid="320"><li data-reactid="321"><a href="https://github.com/imcuttle/live-markd" data-reactid="322">live-markd</a><!-- react-text: 323 --> - GitHub markdown 风格本地实时书写 markdown + 同步定位修改节点<!-- /react-text --></li><li data-reactid="324"><a href="https://github.com/imcuttle/detect-one-changed" data-reactid="325">detect-one-changed</a><!-- react-text: 326 --> - Markdown / Html 修改检测<!-- /react-text --></li></ul></article></div><div class="gitment-container" data-reactid="327"></div><div class="paginator" data-reactid="328"><a title="多叉树的差异对比算法与应用" class="prev" href="/detect-tree-changed" data-reactid="329">Prev</a><a title="告别庞大 PSD，轻松测量尺寸" class="next" href="/make-psd-measurable" data-reactid="330">Next</a></div></div></main><footer data-reactid="331"><div class="copyright" data-reactid="332"><p data-reactid="333"><!-- react-text: 334 -->© 2017. Powered By <!-- /react-text --><a href="https://github.com/picidaejs/picidae" data-reactid="335">Picidae</a></p></div></footer></div>
</div>
<audio id="music" controls autoplay src="http://www.170mv.com/kw/other.web.ri01.sycdn.kuwo.cn/resource/n3/25/67/3891786006.mp3"></audio>
<script>
  !function () {
    var a = document.getElementById("music")
    a && (a.volume = 1)
  }()
</script>
<script src="/PICIDAE_COMMON.js"></script>
<script src="/PICIDAE_ENTRY.js"></script>
</body>
</html>
