<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png" />
    <title> imCuttle </title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
<div id="root">
    <div class="wrap" data-reactroot="" data-reactid="1" data-react-checksum="1701292942"><header data-reactid="2"><a class="logo-link" href="/" data-reactid="3"><img src="/favicon.png" data-reactid="4"/></a><ul class="nav nav-list" data-reactid="5"><li class="nav-list-item" data-reactid="6"><a class="nav-list-link" href="/posts/1" data-reactid="7">Posts</a></li></ul></header><main data-reactid="8"><div class="post" data-reactid="9"><article class="post-block" data-reactid="10"><h1 class="post-title" data-reactid="11">H5之「离线应用」</h1><div class="post-info" data-reactid="12"><time datetime="2016-09-07T23:20:45+00:00" data-reactid="13">Sep 7, 2016 11:20 PM</time></div></article><div class="post-content" data-reactid="14"><article data-reactid="15"><p data-reactid="16">「离线存储」：顾名思义，在有线的环境下先缓存数据（包括静态资源，动态资源），从而在离线环境下，依旧可以正常使用应用（单页应用）</p><!-- react-text: 17 -->
<!-- /react-text --><!-- react-text: 18 -->
<!-- /react-text --><h2 id="静态资源存储applicationcache" data-reactid="19"><a href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E5%AD%98%E5%82%A8applicationcache" aria-hidden="true" data-reactid="20"><span class="icon icon-link" data-reactid="21"></span></a><!-- react-text: 22 -->静态资源存储(ApplicationCache)<!-- /react-text --></h2><!-- react-text: 23 -->
<!-- /react-text --><p data-reactid="24"><a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/applicationCache" data-reactid="25">applicationCache</a><!-- react-text: 26 --> 是一套h5静态资源缓存方案.
利用该技术可以实现配置静态资源/转发请求，加快应用加载速度，降低服务器负载.<!-- /react-text --></p><!-- react-text: 27 -->
<!-- /react-text --><h3 id="基本用法" data-reactid="28"><a href="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95" aria-hidden="true" data-reactid="29"><span class="icon icon-link" data-reactid="30"></span></a><!-- react-text: 31 -->基本用法<!-- /react-text --></h3><!-- react-text: 32 -->
<!-- /react-text --><ol data-reactid="33"><!-- react-text: 34 -->
<!-- /react-text --><li data-reactid="35">引入manifest配置文件</li><!-- react-text: 36 -->
<!-- /react-text --></ol><!-- react-text: 37 -->
<!-- /react-text --><pre data-reactid="38"><code class="hljs language-html" data-query="{}" data-lang="html" data-reactid="39"><span class="hljs-meta" data-reactid="40">&lt;!doctype html&gt;</span><!-- react-text: 41 -->
<!-- /react-text --><span class="hljs-tag" data-reactid="42"><!-- react-text: 43 -->&lt;<!-- /react-text --><span class="hljs-name" data-reactid="44">html</span><!-- react-text: 45 --> <!-- /react-text --><span class="hljs-attr" data-reactid="46">manifest</span><!-- react-text: 47 -->=<!-- /react-text --><span class="hljs-string" data-reactid="48">&quot;cache.manifest&quot;</span><!-- react-text: 49 -->&gt;<!-- /react-text --></span><!-- react-text: 50 -->
    <!-- /react-text --><span class="hljs-tag" data-reactid="51"><!-- react-text: 52 -->&lt;<!-- /react-text --><span class="hljs-name" data-reactid="53">head</span><!-- react-text: 54 -->&gt;<!-- /react-text --></span><!-- react-text: 55 -->
        ...
    <!-- /react-text --><span class="hljs-tag" data-reactid="56"><!-- react-text: 57 -->&lt;/<!-- /react-text --><span class="hljs-name" data-reactid="58">head</span><!-- react-text: 59 -->&gt;<!-- /react-text --></span><!-- react-text: 60 -->
    <!-- /react-text --><span class="hljs-tag" data-reactid="61"><!-- react-text: 62 -->&lt;<!-- /react-text --><span class="hljs-name" data-reactid="63">body</span><!-- react-text: 64 -->&gt;<!-- /react-text --></span><!-- react-text: 65 -->
        ...
    <!-- /react-text --><span class="hljs-tag" data-reactid="66"><!-- react-text: 67 -->&lt;/<!-- /react-text --><span class="hljs-name" data-reactid="68">body</span><!-- react-text: 69 -->&gt;<!-- /react-text --></span><!-- react-text: 70 -->
<!-- /react-text --><span class="hljs-tag" data-reactid="71"><!-- react-text: 72 -->&lt;/<!-- /react-text --><span class="hljs-name" data-reactid="73">html</span><!-- react-text: 74 -->&gt;<!-- /react-text --></span></code></pre><!-- react-text: 75 -->
<!-- /react-text --><ol start="2" data-reactid="76"><!-- react-text: 77 -->
<!-- /react-text --><li data-reactid="78">配置manifest文件</li><!-- react-text: 79 -->
<!-- /react-text --></ol><!-- react-text: 80 -->
<!-- /react-text --><pre data-reactid="81"><code class="hljs language-sh" data-query="{}" data-lang="sh" data-reactid="82"><!-- react-text: 83 -->CACHE MANIFEST
<!-- /react-text --><span class="hljs-comment" data-reactid="84"># 修改配置后，附加上下面一段js代码，才能更新缓存</span><!-- react-text: 85 -->
<!-- /react-text --><span class="hljs-comment" data-reactid="86"># 2016972143</span><!-- react-text: 87 -->
<!-- /react-text --><span class="hljs-comment" data-reactid="88"># 注释：需要缓存的文件，无论在线与否，均从缓存里读取</span><!-- react-text: 89 -->
CACHE:
/dist/0.eda078350ef514670764.bundle.js
/dist/common.bundle.js?v=2016972143
/dist/df9f379beae2559b27044dcfdc0653ab.png?v=2016972143
/dist/home.bundle.js?v=2016972143
/dist/home.css?v=2016972143
uncached.js?v=2016972143

<!-- /react-text --><span class="hljs-comment" data-reactid="90">#cached.css</span><!-- react-text: 91 -->

<!-- /react-text --><span class="hljs-comment" data-reactid="92"># 注释：不缓存的文件，无论缓存中存在与否，均从新获取</span><!-- react-text: 93 -->
NETWORK:
*
<!-- /react-text --><span class="hljs-comment" data-reactid="94">#uncached.js</span><!-- react-text: 95 -->
<!-- /react-text --><span class="hljs-comment" data-reactid="96">#uncached.css</span><!-- react-text: 97 -->

<!-- /react-text --><span class="hljs-comment" data-reactid="98"># 注释：获取不到资源时的备选路径，如index.html访问失败，则返回404页面</span><!-- react-text: 99 -->
FALLBACK:
<!-- /react-text --><span class="hljs-comment" data-reactid="100">#/v1/team/dirlists mock/team_dirlists.json</span><!-- react-text: 101 -->
<!-- /react-text --><span class="hljs-comment" data-reactid="102">#/v1/team/app_filelist?isAdd=0&amp;source=team&amp;page=1&amp;pageSize=10&amp;sort=ftime&amp;from=hiwebapp&amp;fid=t293 mock/team_app_filelist.json</span><!-- react-text: 103 -->
<!-- /react-text --><span class="hljs-comment" data-reactid="104">#index.html 404.html</span></code></pre><!-- react-text: 105 -->
<!-- /react-text --><ol start="3" data-reactid="106"><!-- react-text: 107 -->
<!-- /react-text --><li data-reactid="108">书写更新缓冲js</li><!-- react-text: 109 -->
<!-- /react-text --></ol><!-- react-text: 110 -->
<!-- /react-text --><pre data-reactid="111"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="112"><span class="hljs-comment" data-reactid="113">// 每次打开页面执行该代码段，更新缓存</span><!-- react-text: 114 -->
<!-- /react-text --><span class="hljs-comment" data-reactid="115">// !!! 注意：更新缓存后不会立即生效，需要重新加载页面</span><!-- react-text: 116 -->
(<!-- /react-text --><span class="hljs-function" data-reactid="117"><span class="hljs-keyword" data-reactid="118">function</span><!-- react-text: 119 --> (<!-- /react-text --><span class="hljs-params" data-reactid="120"></span><!-- react-text: 121 -->) <!-- /react-text --></span><!-- react-text: 122 -->{
    <!-- /react-text --><span class="hljs-keyword" data-reactid="123">var</span><!-- react-text: 124 --> cache = <!-- /react-text --><span class="hljs-built_in" data-reactid="125">window</span><!-- react-text: 126 -->.applicationCache;

    cache.addEventListener(<!-- /react-text --><span class="hljs-string" data-reactid="127">&#x27;updateready&#x27;</span><!-- react-text: 128 -->, <!-- /react-text --><span class="hljs-function" data-reactid="129"><span class="hljs-keyword" data-reactid="130">function</span><!-- react-text: 131 -->(<!-- /react-text --><span class="hljs-params" data-reactid="132">e</span><!-- react-text: 133 -->) <!-- /react-text --></span><!-- react-text: 134 -->{
        <!-- /react-text --><span class="hljs-keyword" data-reactid="135">if</span><!-- react-text: 136 --> (cache.status == cache.UPDATEREADY) {
            <!-- /react-text --><span class="hljs-comment" data-reactid="137">// Browser downloaded a new app cache.</span><!-- react-text: 138 -->
            <!-- /react-text --><span class="hljs-comment" data-reactid="139">// if (confirm(&#x27;A new version of this site is available. Load it?&#x27;)) {</span><!-- react-text: 140 -->
                cache.swapCache();
                <!-- /react-text --><span class="hljs-built_in" data-reactid="141">window</span><!-- react-text: 142 -->.location.reload();
            <!-- /react-text --><span class="hljs-comment" data-reactid="143">// }</span><!-- react-text: 144 -->
        } <!-- /react-text --><span class="hljs-keyword" data-reactid="145">else</span><!-- react-text: 146 --> {
            <!-- /react-text --><span class="hljs-comment" data-reactid="147">// Manifest didn&#x27;t changed. Nothing new to server.</span><!-- react-text: 148 -->
        }
    }, <!-- /react-text --><span class="hljs-literal" data-reactid="149">false</span><!-- react-text: 150 -->);

    cache.update()

}())<!-- /react-text --></code></pre><!-- react-text: 151 -->
<!-- /react-text --><ol start="4" data-reactid="152"><!-- react-text: 153 -->
<!-- /react-text --><li data-reactid="154"><!-- react-text: 155 -->
<!-- /react-text --><p data-reactid="156">服务器配置</p><!-- react-text: 157 -->
<!-- /react-text --><ol data-reactid="158"><!-- react-text: 159 -->
<!-- /react-text --><li data-reactid="160"><!-- react-text: 161 -->
<!-- /react-text --><p data-reactid="162"><!-- react-text: 163 -->配置manifest文件，响应 <!-- /react-text --><code data-reactid="164">Content-Type: text/cache-manifest</code><!-- react-text: 165 --> <!-- /react-text --><code data-reactid="166">Cache-Control: max-age=0</code></p><!-- react-text: 167 -->
<!-- /react-text --></li><!-- react-text: 168 -->
<!-- /react-text --><li data-reactid="169"><!-- react-text: 170 -->
<!-- /react-text --><p data-reactid="171">部署线上代码时更新manifest版本号与配置</p><!-- react-text: 172 -->
<!-- /react-text --></li><!-- react-text: 173 -->
<!-- /react-text --></ol><!-- react-text: 174 -->
<!-- /react-text --></li><!-- react-text: 175 -->
<!-- /react-text --></ol><!-- react-text: 176 -->
<!-- /react-text --><p data-reactid="177"><!-- react-text: 178 -->按照以上配置，这样就能实现静态资源缓存
<!-- /react-text --><img src="http://obu9je6ng.bkt.clouddn.com/FvEkGfGFiqRIPaoqrCm-dvTET2Xp?imageslim" alt="ClipboardImage" width="674" height="325" data-reactid="179"/><!-- react-text: 180 -->
如上图，<!-- /react-text --><code data-reactid="181">from cache</code><!-- react-text: 182 -->的加载时间相比其他网络请求快得多！<!-- /react-text --><br data-reactid="183"/><!-- react-text: 184 -->
其中的<!-- /react-text --><code data-reactid="185">fetch/ajax</code><!-- react-text: 186 -->请求不能够通过静态资源存储，因为响应结果是可能会变的.<!-- /react-text --></p><!-- react-text: 187 -->
<!-- /react-text --><p data-reactid="188">那么对于异步ajax请求（动态资源）要通过什么方法才能存储起来呢？实现真正意义的离线存储.</p><!-- react-text: 189 -->
<!-- /react-text --><h2 id="动态资源存储websqlindexeddb" data-reactid="190"><a href="#%E5%8A%A8%E6%80%81%E8%B5%84%E6%BA%90%E5%AD%98%E5%82%A8websqlindexeddb" aria-hidden="true" data-reactid="191"><span class="icon icon-link" data-reactid="192"></span></a><!-- react-text: 193 -->动态资源存储(WebSQL/IndexedDB)<!-- /react-text --></h2><!-- react-text: 194 -->
<!-- /react-text --><p data-reactid="195">使用前端数据库可以较为灵活的控制动态资源存储，在这里我使用了indexedDB, 为什么不用WebSQL？
1. 之前做在线聊天应用时，使用过WebSQL存储聊天记录
2. WebSQL已经被弃用
3. WebSQL是传统的关系数据库，indexedDB是主流的NoSQL DB</p><!-- react-text: 196 -->
<!-- /react-text --><h3 id="基本用法-1" data-reactid="197"><a href="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95-1" aria-hidden="true" data-reactid="198"><span class="icon icon-link" data-reactid="199"></span></a><!-- react-text: 200 -->基本用法<!-- /react-text --></h3><!-- react-text: 201 -->
<!-- /react-text --><ol data-reactid="202"><!-- react-text: 203 -->
<!-- /react-text --><li data-reactid="204">创建一个通用的数据库访问接口</li><!-- react-text: 205 -->
<!-- /react-text --></ol><!-- react-text: 206 -->
<!-- /react-text --><pre data-reactid="207"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="208"><span class="hljs-keyword" data-reactid="209">var</span><!-- react-text: 210 --> indexedDB = <!-- /react-text --><span class="hljs-built_in" data-reactid="211">window</span><!-- react-text: 212 -->.indexedDB || <!-- /react-text --><span class="hljs-built_in" data-reactid="213">window</span><!-- react-text: 214 -->.msIndexedDB || <!-- /react-text --><span class="hljs-built_in" data-reactid="215">window</span><!-- react-text: 216 -->.mozIndexedDB || <!-- /react-text --><span class="hljs-built_in" data-reactid="217">window</span><!-- react-text: 218 -->.webkitIndexedDB;

<!-- /react-text --><span class="hljs-comment" data-reactid="219">// memCache 内存缓冲，避免频繁的读写数据库</span><!-- react-text: 220 -->
<!-- /react-text --><span class="hljs-keyword" data-reactid="221">var</span><!-- react-text: 222 --> req, db, memCache = {};
<!-- /react-text --><span class="hljs-keyword" data-reactid="223">if</span><!-- react-text: 224 -->(indexedDB) {
    <!-- /react-text --><span class="hljs-comment" data-reactid="225">// version：2</span><!-- react-text: 226 -->
    req = indexedDB.open(<!-- /react-text --><span class="hljs-string" data-reactid="227">&#x27;ajax_cache&#x27;</span><!-- react-text: 228 -->, <!-- /react-text --><span class="hljs-number" data-reactid="229">2</span><!-- react-text: 230 -->);
    <!-- /react-text --><span class="hljs-comment" data-reactid="231">// 保证caches成功创建</span><!-- react-text: 232 -->
    req.onsuccess = <!-- /react-text --><span class="hljs-function" data-reactid="233"><span class="hljs-keyword" data-reactid="234">function</span><!-- react-text: 235 --> (<!-- /react-text --><span class="hljs-params" data-reactid="236">e</span><!-- react-text: 237 -->) <!-- /react-text --></span><!-- react-text: 238 -->{
        db = e.target.result;
        <!-- /react-text --><span class="hljs-keyword" data-reactid="239">if</span><!-- react-text: 240 -->(!db.objectStoreNames.contains(<!-- /react-text --><span class="hljs-string" data-reactid="241">&#x27;caches&#x27;</span><!-- react-text: 242 -->)){
            db.createObjectStore(<!-- /react-text --><span class="hljs-string" data-reactid="243">&#x27;caches&#x27;</span><!-- react-text: 244 -->, {<!-- /react-text --><span class="hljs-attr" data-reactid="245">keyPath</span><!-- react-text: 246 -->: <!-- /react-text --><span class="hljs-string" data-reactid="247">&quot;id&quot;</span><!-- react-text: 248 -->});
        }
    }
    <!-- /react-text --><span class="hljs-comment" data-reactid="249">// 数据库版本改变触发</span><!-- react-text: 250 -->
    req.onupgradeneeded=<!-- /react-text --><span class="hljs-function" data-reactid="251"><span class="hljs-keyword" data-reactid="252">function</span><!-- react-text: 253 -->(<!-- /react-text --><span class="hljs-params" data-reactid="254">e</span><!-- react-text: 255 -->)<!-- /react-text --></span><!-- react-text: 256 -->{
        <!-- /react-text --><span class="hljs-keyword" data-reactid="257">var</span><!-- react-text: 258 --> db=e.target.result;
        <!-- /react-text --><span class="hljs-keyword" data-reactid="259">if</span><!-- react-text: 260 -->(!db.objectStoreNames.contains(<!-- /react-text --><span class="hljs-string" data-reactid="261">&#x27;caches&#x27;</span><!-- react-text: 262 -->)){
            db.createObjectStore(<!-- /react-text --><span class="hljs-string" data-reactid="263">&#x27;caches&#x27;</span><!-- react-text: 264 -->, {<!-- /react-text --><span class="hljs-attr" data-reactid="265">keyPath</span><!-- react-text: 266 -->: <!-- /react-text --><span class="hljs-string" data-reactid="267">&quot;id&quot;</span><!-- react-text: 268 -->});
        }
        <!-- /react-text --><span class="hljs-built_in" data-reactid="269">console</span><!-- react-text: 270 -->.log(<!-- /react-text --><span class="hljs-string" data-reactid="271">&#x27;DB version changed to &#x27;</span><!-- react-text: 272 --> + db.version);
    };
    req.onerror = <!-- /react-text --><span class="hljs-function" data-reactid="273"><span class="hljs-keyword" data-reactid="274">function</span><!-- react-text: 275 --> (<!-- /react-text --><span class="hljs-params" data-reactid="276">err</span><!-- react-text: 277 -->) <!-- /react-text --></span><!-- react-text: 278 -->{
        <!-- /react-text --><span class="hljs-built_in" data-reactid="279">console</span><!-- react-text: 280 -->.error(<!-- /react-text --><span class="hljs-string" data-reactid="281">&#x27;indexedDB open failed. &#x27;</span><!-- react-text: 282 -->, err)
    }
}

<!-- /react-text --><span class="hljs-keyword" data-reactid="283">export</span><!-- react-text: 284 --> <!-- /react-text --><span class="hljs-keyword" data-reactid="285">default</span><!-- react-text: 286 --> {
    <!-- /react-text --><span class="hljs-attr" data-reactid="287">isSupported</span><!-- react-text: 288 -->: !!indexedDB,
    <!-- /react-text --><span class="hljs-attr" data-reactid="289">set</span><!-- react-text: 290 -->: <!-- /react-text --><span class="hljs-function" data-reactid="291"><!-- react-text: 292 -->(<!-- /react-text --><span class="hljs-params" data-reactid="293">id, data</span><!-- react-text: 294 -->) =&gt;<!-- /react-text --></span><!-- react-text: 295 --> {
        <!-- /react-text --><span class="hljs-keyword" data-reactid="296">var</span><!-- react-text: 297 --> entity = {
            <!-- /react-text --><span class="hljs-attr" data-reactid="298">id</span><!-- react-text: 299 -->: id,
            <!-- /react-text --><span class="hljs-attr" data-reactid="300">data</span><!-- react-text: 301 -->: data
        }
        <!-- /react-text --><span class="hljs-keyword" data-reactid="302">var</span><!-- react-text: 303 --> transaction = db.transaction(<!-- /react-text --><span class="hljs-string" data-reactid="304">&#x27;caches&#x27;</span><!-- react-text: 305 -->, <!-- /react-text --><span class="hljs-string" data-reactid="306">&#x27;readwrite&#x27;</span><!-- react-text: 307 -->);
        <!-- /react-text --><span class="hljs-keyword" data-reactid="308">var</span><!-- react-text: 309 --> store = transaction.objectStore(<!-- /react-text --><span class="hljs-string" data-reactid="310">&#x27;caches&#x27;</span><!-- react-text: 311 -->);
        <!-- /react-text --><span class="hljs-keyword" data-reactid="312">var</span><!-- react-text: 313 --> req = store.put(entity);
        req.onerror = <!-- /react-text --><span class="hljs-function" data-reactid="314"><span class="hljs-params" data-reactid="315">()</span><!-- react-text: 316 --> =&gt;<!-- /react-text --></span><!-- react-text: 317 --> {
            <!-- /react-text --><span class="hljs-built_in" data-reactid="318">console</span><!-- react-text: 319 -->.error(<!-- /react-text --><span class="hljs-string" data-reactid="320">&#x27;put data failed. &#x27;</span><!-- react-text: 321 -->, entity)
        }
        req.onsuccess = <!-- /react-text --><span class="hljs-function" data-reactid="322"><span class="hljs-params" data-reactid="323">()</span><!-- react-text: 324 --> =&gt;<!-- /react-text --></span><!-- react-text: 325 --> {
            memCache[id] = data
            <!-- /react-text --><span class="hljs-built_in" data-reactid="326">console</span><!-- react-text: 327 -->.info(<!-- /react-text --><span class="hljs-string" data-reactid="328">&#x27;put data successed. &#x27;</span><!-- react-text: 329 -->, entity)
        }
    },
    <!-- /react-text --><span class="hljs-attr" data-reactid="330">get</span><!-- react-text: 331 -->: <!-- /react-text --><span class="hljs-function" data-reactid="332"><!-- react-text: 333 -->(<!-- /react-text --><span class="hljs-params" data-reactid="334">id</span><!-- react-text: 335 -->) =&gt;<!-- /react-text --></span><!-- react-text: 336 --> {
        <!-- /react-text --><span class="hljs-keyword" data-reactid="337">return</span><!-- react-text: 338 --> <!-- /react-text --><span class="hljs-keyword" data-reactid="339">new</span><!-- react-text: 340 --> <!-- /react-text --><span class="hljs-built_in" data-reactid="341">Promise</span><!-- react-text: 342 -->(<!-- /react-text --><span class="hljs-function" data-reactid="343"><!-- react-text: 344 -->(<!-- /react-text --><span class="hljs-params" data-reactid="345">resolve, reject</span><!-- react-text: 346 -->) =&gt;<!-- /react-text --></span><!-- react-text: 347 --> {
            <!-- /react-text --><span class="hljs-keyword" data-reactid="348">if</span><!-- react-text: 349 -->(memCache[id]) {
                resolve(memCache[id]);
                <!-- /react-text --><span class="hljs-keyword" data-reactid="350">return</span><!-- react-text: 351 -->;
            }

            <!-- /react-text --><span class="hljs-keyword" data-reactid="352">var</span><!-- react-text: 353 --> transaction = db.transaction(<!-- /react-text --><span class="hljs-string" data-reactid="354">&#x27;caches&#x27;</span><!-- react-text: 355 -->, <!-- /react-text --><span class="hljs-string" data-reactid="356">&#x27;readwrite&#x27;</span><!-- react-text: 357 -->);
            <!-- /react-text --><span class="hljs-keyword" data-reactid="358">var</span><!-- react-text: 359 --> store = transaction.objectStore(<!-- /react-text --><span class="hljs-string" data-reactid="360">&#x27;caches&#x27;</span><!-- react-text: 361 -->);
            <!-- /react-text --><span class="hljs-keyword" data-reactid="362">var</span><!-- react-text: 363 --> req = store.get(id);
            req.onerror = <!-- /react-text --><span class="hljs-function" data-reactid="364"><span class="hljs-params" data-reactid="365">()</span><!-- react-text: 366 --> =&gt;<!-- /react-text --></span><!-- react-text: 367 --> {
                <!-- /react-text --><span class="hljs-built_in" data-reactid="368">console</span><!-- react-text: 369 -->.error(<!-- /react-text --><span class="hljs-string" data-reactid="370">&#x27;get data failed. &#x27;</span><!-- react-text: 371 -->, id)
                resolve()
            }
            req.onsuccess = <!-- /react-text --><span class="hljs-function" data-reactid="372"><!-- react-text: 373 -->(<!-- /react-text --><span class="hljs-params" data-reactid="374">e</span><!-- react-text: 375 -->) =&gt;<!-- /react-text --></span><!-- react-text: 376 --> {
                <!-- /react-text --><span class="hljs-keyword" data-reactid="377">var</span><!-- react-text: 378 --> rlt = e.target.result;
                <!-- /react-text --><span class="hljs-built_in" data-reactid="379">console</span><!-- react-text: 380 -->.info(<!-- /react-text --><span class="hljs-string" data-reactid="381">&#x27;get data successed. &#x27;</span><!-- react-text: 382 -->, id, rlt)
                resolve(rlt &amp;&amp; rlt.data)
            }
        })
    }
}<!-- /react-text --></code></pre><!-- react-text: 383 -->
<!-- /react-text --><ol start="2" data-reactid="384"><!-- react-text: 385 -->
<!-- /react-text --><li data-reactid="386">重写fetch/ajax方法</li><!-- react-text: 387 -->
<!-- /react-text --></ol><!-- react-text: 388 -->
<!-- /react-text --><pre data-reactid="389"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="390"><span class="hljs-comment" data-reactid="391">/* reset fetch function for offline be compatible*/</span><!-- react-text: 392 -->
<!-- /react-text --><span class="hljs-keyword" data-reactid="393">var</span><!-- react-text: 394 --> fetch = <!-- /react-text --><span class="hljs-built_in" data-reactid="395">require</span><!-- react-text: 396 -->(<!-- /react-text --><span class="hljs-string" data-reactid="397">&#x27;isomorphic-fetch&#x27;</span><!-- react-text: 398 -->)
<!-- /react-text --><span class="hljs-keyword" data-reactid="399">import</span><!-- react-text: 400 --> {parse} <!-- /react-text --><span class="hljs-keyword" data-reactid="401">from</span><!-- react-text: 402 --> <!-- /react-text --><span class="hljs-string" data-reactid="403">&#x27;url&#x27;</span><!-- react-text: 404 -->

<!-- /react-text --><span class="hljs-keyword" data-reactid="405">var</span><!-- react-text: 406 --> __fetch = fetch;
fetch = <!-- /react-text --><span class="hljs-function" data-reactid="407"><span class="hljs-keyword" data-reactid="408">function</span><!-- react-text: 409 --> (<!-- /react-text --><span class="hljs-params" data-reactid="410">url</span><!-- react-text: 411 -->) <!-- /react-text --></span><!-- react-text: 412 -->{
    <!-- /react-text --><span class="hljs-keyword" data-reactid="413">var</span><!-- react-text: 414 --> rlt = parse(url, <!-- /react-text --><span class="hljs-literal" data-reactid="415">true</span><!-- react-text: 416 -->);
    <!-- /react-text --><span class="hljs-function" data-reactid="417"><span class="hljs-keyword" data-reactid="418">function</span><!-- react-text: 419 --> <!-- /react-text --><span class="hljs-title" data-reactid="420">generateJson</span><!-- react-text: 421 -->(<!-- /react-text --><span class="hljs-params" data-reactid="422">json</span><!-- react-text: 423 -->) <!-- /react-text --></span><!-- react-text: 424 -->{
        <!-- /react-text --><span class="hljs-keyword" data-reactid="425">return</span><!-- react-text: 426 --> {
            <!-- /react-text --><span class="hljs-attr" data-reactid="427">json</span><!-- react-text: 428 -->: <!-- /react-text --><span class="hljs-function" data-reactid="429"><span class="hljs-keyword" data-reactid="430">function</span><!-- react-text: 431 --> (<!-- /react-text --><span class="hljs-params" data-reactid="432"></span><!-- react-text: 433 -->) <!-- /react-text --></span><!-- react-text: 434 -->{
                <!-- /react-text --><span class="hljs-keyword" data-reactid="435">return</span><!-- react-text: 436 --> json
            }
        }
    }
    <!-- /react-text --><span class="hljs-function" data-reactid="437"><span class="hljs-keyword" data-reactid="438">function</span><!-- react-text: 439 --> <!-- /react-text --><span class="hljs-title" data-reactid="440">generateErrorJson</span><!-- react-text: 441 -->(<!-- /react-text --><span class="hljs-params" data-reactid="442"></span><!-- react-text: 443 -->) <!-- /react-text --></span><!-- react-text: 444 -->{
        <!-- /react-text --><span class="hljs-keyword" data-reactid="445">return</span><!-- react-text: 446 --> generateJson({
            <!-- /react-text --><span class="hljs-attr" data-reactid="447">errno</span><!-- react-text: 448 -->: <!-- /react-text --><span class="hljs-number" data-reactid="449">500</span><!-- react-text: 450 -->, <!-- /react-text --><span class="hljs-attr" data-reactid="451">errmsg</span><!-- react-text: 452 -->: <!-- /react-text --><span class="hljs-string" data-reactid="453">&#x27;你正处于离线状态&#x27;</span><!-- react-text: 454 -->,
            <!-- /react-text --><span class="hljs-attr" data-reactid="455">result</span><!-- react-text: 456 -->: {
                <!-- /react-text --><span class="hljs-attr" data-reactid="457">files</span><!-- react-text: 458 -->: []
            }
        })
    }
    <!-- /react-text --><span class="hljs-keyword" data-reactid="459">var</span><!-- react-text: 460 --> query = rlt.query;
    <!-- /react-text --><span class="hljs-comment" data-reactid="461">// 去掉时间戳与重复的from参数</span><!-- react-text: 462 -->
    <!-- /react-text --><span class="hljs-keyword" data-reactid="463">delete</span><!-- react-text: 464 --> query.t;
    <!-- /react-text --><span class="hljs-keyword" data-reactid="465">delete</span><!-- react-text: 466 --> query.from;
    <!-- /react-text --><span class="hljs-keyword" data-reactid="467">var</span><!-- react-text: 468 --> id = rlt.pathname
    <!-- /react-text --><span class="hljs-keyword" data-reactid="469">var</span><!-- react-text: 470 --> key = MyUtils.jsonToUrl(query)
    <!-- /react-text --><span class="hljs-keyword" data-reactid="471">if</span><!-- react-text: 472 -->(MyUtils.isOffline()) { <!-- /react-text --><span class="hljs-comment" data-reactid="473">// 离线</span><!-- react-text: 474 -->
        <!-- /react-text --><span class="hljs-keyword" data-reactid="475">if</span><!-- react-text: 476 -->(!id) {
            <!-- /react-text --><span class="hljs-keyword" data-reactid="477">return</span><!-- react-text: 478 --> <!-- /react-text --><span class="hljs-keyword" data-reactid="479">new</span><!-- react-text: 480 --> <!-- /react-text --><span class="hljs-built_in" data-reactid="481">Promise</span><!-- react-text: 482 -->(<!-- /react-text --><span class="hljs-function" data-reactid="483"><!-- react-text: 484 -->(<!-- /react-text --><span class="hljs-params" data-reactid="485">resolve, reject</span><!-- react-text: 486 -->) =&gt;<!-- /react-text --></span><!-- react-text: 487 --> {
                resolve(generateErrorJson())
            })
        } <!-- /react-text --><span class="hljs-keyword" data-reactid="488">else</span><!-- react-text: 489 --> {
            <!-- /react-text --><span class="hljs-keyword" data-reactid="490">if</span><!-- react-text: 491 -->(DB.isSupported) {
                <!-- /react-text --><span class="hljs-keyword" data-reactid="492">return</span><!-- react-text: 493 --> DB.get(id).then(<!-- /react-text --><span class="hljs-function" data-reactid="494"><span class="hljs-params" data-reactid="495">json</span><!-- react-text: 496 --> =&gt;<!-- /react-text --></span><!-- react-text: 497 --> {
                    <!-- /react-text --><span class="hljs-keyword" data-reactid="498">return</span><!-- react-text: 499 --> (!json || !json[key])
                        ? generateErrorJson()
                        : generateJson(json[key])
                })
            } <!-- /react-text --><span class="hljs-keyword" data-reactid="500">else</span><!-- react-text: 501 --> {
                <!-- /react-text --><span class="hljs-keyword" data-reactid="502">return</span><!-- react-text: 503 --> <!-- /react-text --><span class="hljs-keyword" data-reactid="504">new</span><!-- react-text: 505 --> <!-- /react-text --><span class="hljs-built_in" data-reactid="506">Promise</span><!-- react-text: 507 -->(<!-- /react-text --><span class="hljs-function" data-reactid="508"><!-- react-text: 509 -->(<!-- /react-text --><span class="hljs-params" data-reactid="510">resolve, reject</span><!-- react-text: 511 -->) =&gt;<!-- /react-text --></span><!-- react-text: 512 --> {
                    resolve(generateErrorJson())
                })
            }
        }
    } <!-- /react-text --><span class="hljs-keyword" data-reactid="513">else</span><!-- react-text: 514 --> {
        <!-- /react-text --><span class="hljs-keyword" data-reactid="515">return</span><!-- react-text: 516 --> __fetch.apply(<!-- /react-text --><span class="hljs-literal" data-reactid="517">null</span><!-- react-text: 518 -->, [].slice.call(<!-- /react-text --><span class="hljs-built_in" data-reactid="519">arguments</span><!-- react-text: 520 -->))
            .then(<!-- /react-text --><span class="hljs-function" data-reactid="521"><span class="hljs-params" data-reactid="522">res</span><!-- react-text: 523 --> =&gt;<!-- /react-text --></span><!-- react-text: 524 --> res.json())
            .then( <!-- /react-text --><span class="hljs-function" data-reactid="525"><!-- react-text: 526 -->(<!-- /react-text --><span class="hljs-params" data-reactid="527">resJson</span><!-- react-text: 528 -->) =&gt;<!-- /react-text --></span><!-- react-text: 529 --> {
                <!-- /react-text --><span class="hljs-keyword" data-reactid="530">if</span><!-- react-text: 531 -->(DB.isSupported) {
                    <!-- /react-text --><span class="hljs-keyword" data-reactid="532">var</span><!-- react-text: 533 --> tmp = {};
                    tmp[key] = resJson;
                    DB.get(id).then(<!-- /react-text --><span class="hljs-function" data-reactid="534"><span class="hljs-params" data-reactid="535">json</span><!-- react-text: 536 --> =&gt;<!-- /react-text --></span><!-- react-text: 537 --> {
                        DB.set(id, <!-- /react-text --><span class="hljs-built_in" data-reactid="538">Object</span><!-- react-text: 539 -->.assign({}, json, tmp))
                    })
                }
                <!-- /react-text --><span class="hljs-keyword" data-reactid="540">return</span><!-- react-text: 541 --> generateJson(resJson)
            }
        )
    }

}<!-- /react-text --></code></pre><!-- react-text: 542 -->
<!-- /react-text --><p data-reactid="543"><!-- react-text: 544 -->可以在chrome的web tool中看到indexedDB<!-- /react-text --><br data-reactid="545"/><!-- react-text: 546 -->
<!-- /react-text --><img src="http://obu9je6ng.bkt.clouddn.com/FmF0kN7KEA15rnXMaMMC-32EeTqg?imageslim" alt="ClipboardImage" width="473" height="431" data-reactid="547"/><!-- react-text: 548 -->
每次请求都缓存下来了<!-- /react-text --></p><!-- react-text: 549 -->
<!-- /react-text --><p data-reactid="550">在脱离网络后！依旧可以模拟异步请求！</p><!-- react-text: 551 -->
<!-- /react-text --></article></div><div class="gitment-container" data-reactid="552"></div><div class="paginator" data-reactid="553"><a title="分片上传与断点续传解决方案" class="prev" href="/slice-and-breakpoint-up-down" data-reactid="554">Prev</a><a title="点歌机器人 (来自网易云音乐)" class="next" href="/request-song-robot" data-reactid="555">Next</a></div></div></main><footer data-reactid="556"><div class="copyright" data-reactid="557"><p data-reactid="558"><!-- react-text: 559 -->© 2017. Powered By <!-- /react-text --><a href="https://github.com/picidaejs/picidae" data-reactid="560">Picidae</a></p></div></footer></div>
</div>
<script src="/PICIDAE_COMMON.js"></script>
<script src="/PICIDAE_ENTRY.js"></script>
</body>
</html>