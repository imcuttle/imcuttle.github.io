<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png" />
    <title> imCuttle </title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
<div id="root">
    <div class="wrap" data-reactroot="" data-reactid="1" data-react-checksum="549777829"><header data-reactid="2"><a class="logo-link" href="/" data-reactid="3"><img src="/favicon.png" data-reactid="4"/></a><ul class="nav nav-list" data-reactid="5"><li class="nav-list-item" data-reactid="6"><a class="nav-list-link" href="/posts/1" data-reactid="7">Posts</a></li></ul></header><main data-reactid="8"><div class="post" data-reactid="9"><article class="post-block" data-reactid="10"><h1 class="post-title" data-reactid="11">基于Mobx实现 数据 - Url 同步</h1><div class="post-info" data-reactid="12"><time datetime="2017-09-10T00:51:14+00:00" data-reactid="13">Sep 10, 2017 12:51 AM</time></div></article><div class="post-content" data-reactid="14"><article data-reactid="15"><h2 id="需求" data-reactid="16"><a href="#%E9%9C%80%E6%B1%82" aria-hidden="true" data-reactid="17"><span class="icon icon-link" data-reactid="18"></span></a><!-- react-text: 19 -->需求<!-- /react-text --></h2><!-- react-text: 20 -->
<!-- /react-text --><p data-reactid="21">在项目开发初期，未考虑到需要做数据列表页面的数据（如分页、排序、条件查询...）同步至 url.</p><!-- react-text: 22 -->
<!-- /react-text --><p data-reactid="23">但这种需求在对于数据列表是必要的。</p><!-- react-text: 24 -->
<!-- /react-text --><p data-reactid="25">因此需要一种较为“优雅的”方式来“独立”实现数据-url 的同步</p><!-- react-text: 26 -->
<!-- /react-text --><h2 id="思路" data-reactid="27"><a href="#%E6%80%9D%E8%B7%AF" aria-hidden="true" data-reactid="28"><span class="icon icon-link" data-reactid="29"></span></a><!-- react-text: 30 -->思路<!-- /react-text --></h2><!-- react-text: 31 -->
<!-- /react-text --><ol data-reactid="32"><!-- react-text: 33 -->
<!-- /react-text --><li data-reactid="34">首先，项目中的页面结构如下</li><!-- react-text: 35 -->
<!-- /react-text --></ol><!-- react-text: 36 -->
<!-- /react-text --><pre data-reactid="37"><code data-query="{}" data-lang="data-lang" data-reactid="38">state.js    # mobx 
index.js    # react page
...
</code></pre><!-- react-text: 39 -->
<!-- /react-text --><p data-reactid="40">一个view 对应一个 state</p><!-- react-text: 41 -->
<!-- /react-text --><ol start="2" data-reactid="42"><!-- react-text: 43 -->
<!-- /react-text --><li data-reactid="44"><!-- react-text: 45 -->
<!-- /react-text --><p data-reactid="46">我们需要同步的数据一般在 state.js 中</p><!-- react-text: 47 -->
<!-- /react-text --></li><!-- react-text: 48 -->
<!-- /react-text --><li data-reactid="49"><!-- react-text: 50 -->
<!-- /react-text --><p data-reactid="51">约定一个 state &quot;生命周期&quot;规范</p><!-- react-text: 52 -->
<!-- /react-text --></li><!-- react-text: 53 -->
<!-- /react-text --></ol><!-- react-text: 54 -->
<!-- /react-text --><pre data-reactid="55"><code data-query="{}" data-lang="data-lang" data-reactid="56">componentWillMount() -&gt; trigger -&gt; state.init(props)
componentWillReceiveProps() -&gt; trigger -&gt; state.update(newProps) | state.init(newProps)
componentWillUnmount() -&gt; trigger -&gt; state.exit(props)
</code></pre><!-- react-text: 57 -->
<!-- /react-text --><ol start="4" data-reactid="58"><!-- react-text: 59 -->
<!-- /react-text --><li data-reactid="60">在 init 方法中，注入下面的逻辑</li><!-- react-text: 61 -->
<!-- /react-text --></ol><!-- react-text: 62 -->
<!-- /react-text --><pre data-reactid="63"><code data-query="{}" data-lang="data-lang" data-reactid="64">根据 url 预设 state

观察需要同步数据的改动，如果改动了，则将其数据写入url
</code></pre><!-- react-text: 65 -->
<!-- /react-text --><ol start="5" data-reactid="66"><!-- react-text: 67 -->
<!-- /react-text --><li data-reactid="68">在 exit 方法中，注入销毁 init 观察者的逻辑</li><!-- react-text: 69 -->
<!-- /react-text --></ol><!-- react-text: 70 -->
<!-- /react-text --><h2 id="需要注意的点" data-reactid="71"><a href="#%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E7%82%B9" aria-hidden="true" data-reactid="72"><span class="icon icon-link" data-reactid="73"></span></a><!-- react-text: 74 -->需要注意的点<!-- /react-text --></h2><!-- react-text: 75 -->
<!-- /react-text --><ul data-reactid="76"><!-- react-text: 77 -->
<!-- /react-text --><li data-reactid="78">适用于 state 独立于一个 class 的架构</li><!-- react-text: 79 -->
<!-- /react-text --><li data-reactid="80"><!-- react-text: 81 -->state 必须有 <!-- /react-text --><code data-reactid="82">init/exit</code><!-- react-text: 83 --> 周期方法（继承）<!-- /react-text --></li><!-- react-text: 84 -->
<!-- /react-text --><li data-reactid="85"><!-- react-text: 86 -->在对应 View 的生命周期方法中，绑定 state 的 <!-- /react-text --><code data-reactid="87">init/exit</code><!-- react-text: 88 --> 方法（HOC）<!-- /react-text --></li><!-- react-text: 89 -->
<!-- /react-text --></ul><!-- react-text: 90 -->
<!-- /react-text --><h2 id="使用方法" data-reactid="91"><a href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95" aria-hidden="true" data-reactid="92"><span class="icon icon-link" data-reactid="93"></span></a><!-- react-text: 94 -->使用方法<!-- /react-text --></h2><!-- react-text: 95 -->
<!-- /react-text --><ul data-reactid="96"><!-- react-text: 97 -->
<!-- /react-text --><li data-reactid="98"><!-- react-text: 99 -->
<!-- /react-text --><p data-reactid="100">State</p><!-- react-text: 101 -->
<!-- /react-text --><pre data-reactid="102"><code class="hljs language-js" data-query="{}" data-lang="js" data-reactid="103"><span class="hljs-keyword" data-reactid="104">import</span><!-- react-text: 105 --> {urlsync} <!-- /react-text --><span class="hljs-keyword" data-reactid="106">from</span><!-- react-text: 107 --> <!-- /react-text --><span class="hljs-string" data-reactid="108">&#x27;common/decorator&#x27;</span><!-- react-text: 109 -->

<!-- /react-text --><span class="hljs-keyword" data-reactid="110">export</span><!-- react-text: 111 --> <!-- /react-text --><span class="hljs-keyword" data-reactid="112">default</span><!-- react-text: 113 --> <!-- /react-text --><span class="hljs-class" data-reactid="114"><span class="hljs-keyword" data-reactid="115">class</span><!-- react-text: 116 --> <!-- /react-text --><span class="hljs-title" data-reactid="117">State</span><!-- react-text: 118 --> <!-- /react-text --></span><!-- react-text: 119 -->{

    @observable initialized = <!-- /react-text --><span class="hljs-literal" data-reactid="120">false</span><!-- react-text: 121 -->

    <!-- /react-text --><span class="hljs-comment" data-reactid="122">// 若不是observable，urlsync将自动转化为observable</span><!-- react-text: 123 -->
    @urlsync
    deptId = <!-- /react-text --><span class="hljs-string" data-reactid="124">&#x27;&#x27;</span><!-- react-text: 125 -->

    <!-- /react-text --><span class="hljs-comment" data-reactid="126">// 避免重名，使用 page 命名</span><!-- react-text: 127 -->
    @urlsync(<!-- /react-text --><span class="hljs-string" data-reactid="128">&#x27;page&#x27;</span><!-- react-text: 129 -->)
    @observable pagination = <!-- /react-text --><span class="hljs-keyword" data-reactid="130">new</span><!-- react-text: 131 --> Pagination({
        <!-- /react-text --><span class="hljs-attr" data-reactid="132">pageNum</span><!-- react-text: 133 -->: <!-- /react-text --><span class="hljs-number" data-reactid="134">1</span><!-- react-text: 135 -->,
        <!-- /react-text --><span class="hljs-attr" data-reactid="136">total</span><!-- react-text: 137 -->: <!-- /react-text --><span class="hljs-number" data-reactid="138">0</span><!-- react-text: 139 -->,
        <!-- /react-text --><span class="hljs-attr" data-reactid="140">pageSize</span><!-- react-text: 141 -->: <!-- /react-text --><span class="hljs-number" data-reactid="142">10</span><!-- react-text: 143 -->
    })
    
    init() {}
    exit() {}
    ...
}<!-- /react-text --></code></pre><!-- react-text: 144 -->
<!-- /react-text --></li><!-- react-text: 145 -->
<!-- /react-text --><li data-reactid="146"><!-- react-text: 147 -->
<!-- /react-text --><p data-reactid="148">View</p><!-- react-text: 149 -->
<!-- /react-text --><pre data-reactid="150"><code class="hljs language-js" data-query="{}" data-lang="js" data-reactid="151"><span class="hljs-keyword" data-reactid="152">export</span><!-- react-text: 153 --> <!-- /react-text --><span class="hljs-keyword" data-reactid="154">default</span><!-- react-text: 155 --> <!-- /react-text --><span class="hljs-class" data-reactid="156"><span class="hljs-keyword" data-reactid="157">class</span><!-- react-text: 158 --> <!-- /react-text --><span class="hljs-title" data-reactid="159">View</span><!-- react-text: 160 --> <!-- /react-text --><span class="hljs-keyword" data-reactid="161">extends</span><!-- react-text: 162 --> <!-- /react-text --><span class="hljs-title" data-reactid="163">React</span><!-- react-text: 164 -->.<!-- /react-text --><span class="hljs-title" data-reactid="165">Component</span><!-- react-text: 166 --> <!-- /react-text --></span><!-- react-text: 167 -->{
    
    local = <!-- /react-text --><span class="hljs-keyword" data-reactid="168">new</span><!-- react-text: 169 --> State();
    
    componentWillMount() {
        <!-- /react-text --><span class="hljs-keyword" data-reactid="170">this</span><!-- react-text: 171 -->.local.init(<!-- /react-text --><span class="hljs-keyword" data-reactid="172">this</span><!-- react-text: 173 -->.props)
    }
    
    componentWillUnmount() {
        <!-- /react-text --><span class="hljs-keyword" data-reactid="174">this</span><!-- react-text: 175 -->.local.exit(<!-- /react-text --><span class="hljs-keyword" data-reactid="176">this</span><!-- react-text: 177 -->.props)
    }
    
    ...
}<!-- /react-text --></code></pre><!-- react-text: 178 -->
<!-- /react-text --></li><!-- react-text: 179 -->
<!-- /react-text --></ul><!-- react-text: 180 -->
<!-- /react-text --><h2 id="其他问题" data-reactid="181"><a href="#%E5%85%B6%E4%BB%96%E9%97%AE%E9%A2%98" aria-hidden="true" data-reactid="182"><span class="icon icon-link" data-reactid="183"></span></a><!-- react-text: 184 -->其他问题<!-- /react-text --></h2><!-- react-text: 185 -->
<!-- /react-text --><ul data-reactid="186"><!-- react-text: 187 -->
<!-- /react-text --><li data-reactid="188">不适用于数据嵌套过深的数据结构</li><!-- react-text: 189 -->
<!-- /react-text --><li data-reactid="190">url 变得“丑陋”</li><!-- react-text: 191 -->
<!-- /react-text --></ul><!-- react-text: 192 -->
<!-- /react-text --></article></div><div class="gitment-container" data-reactid="193"></div><div class="paginator" data-reactid="194"><a title="妈妈再也不用担心RD部署环境，影响FE开发了" class="prev" href="/birdv3-standup" data-reactid="195">Prev</a><a title="谈一谈React高阶组件" class="next" href="/talk-about-react-hoc" data-reactid="196">Next</a></div></div></main><footer data-reactid="197"><div class="copyright" data-reactid="198"><p data-reactid="199"><!-- react-text: 200 -->© 2017. Powered By <!-- /react-text --><a href="https://github.com/picidaejs/picidae" data-reactid="201">Picidae</a></p></div></footer></div>
</div>
<script src="/PICIDAE_COMMON.js"></script>
<script src="/PICIDAE_ENTRY.js"></script>
</body>
</html>