<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png" />
    <title> imCuttle </title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
<div id="root">
    <div class="wrap" data-reactroot="" data-reactid="1" data-react-checksum="1272846878"><header data-reactid="2"><a class="logo-link" href="/" data-reactid="3"><img src="/favicon.png" data-reactid="4"/></a><ul class="nav nav-list" data-reactid="5"><li class="nav-list-item" data-reactid="6"><a class="nav-list-link" href="/posts/1" data-reactid="7">Posts</a></li></ul></header><main data-reactid="8"><div class="post" data-reactid="9"><article class="post-block" data-reactid="10"><h1 class="post-title" data-reactid="11">「node网络编程」SMTP客户端程序</h1><div class="post-info" data-reactid="12"><time datetime="2016-05-30T22:49:03+00:00" data-reactid="13">May 30, 2016 10:49 PM</time></div></article><div class="post-content" data-reactid="14"><article data-reactid="15"><h1 id="前言" data-reactid="16"><a href="#%E5%89%8D%E8%A8%80" aria-hidden="true" data-reactid="17"><span class="icon icon-link" data-reactid="18"></span></a><!-- react-text: 19 -->前言<!-- /react-text --></h1><!-- react-text: 20 -->
<!-- /react-text --><p data-reactid="21"><!-- react-text: 22 -->本文介绍了<!-- /react-text --><code data-reactid="23">node</code><!-- react-text: 24 -->中<!-- /react-text --><code data-reactid="25">net</code><!-- react-text: 26 -->包使用，以及相关SMTP的知识。<!-- /react-text --></p><!-- react-text: 27 -->
<!-- /react-text --><!-- react-text: 28 -->
<!-- /react-text --><h1 id="知识介绍" data-reactid="29"><a href="#%E7%9F%A5%E8%AF%86%E4%BB%8B%E7%BB%8D" aria-hidden="true" data-reactid="30"><span class="icon icon-link" data-reactid="31"></span></a><!-- react-text: 32 -->知识介绍<!-- /react-text --></h1><!-- react-text: 33 -->
<!-- /react-text --><img src="http://obu9je6ng.bkt.clouddn.com/Fv9jmxVALM06sFrlJUAlys62qFjW?imageslim" alt="ClipboardImage" width="1077" height="661" data-reactid="34"/><!-- react-text: 35 -->
&gt; 如图,电子邮件服务的实现结构，我这里主要讲的是红色圆圈的内容。
<!-- /react-text --><p data-reactid="36"><!-- react-text: 37 -->下面是一次客户端成功发送QQ邮件的服务器响应和客户端请求的全过程。<!-- /react-text --><strong data-reactid="38">（数字开头的即为服务器响应）</strong></p><!-- react-text: 39 -->
<!-- /react-text --><pre data-reactid="40"><code data-query="{}" data-lang="data-lang" data-reactid="41">HELO moyu

220 smtp.qq.com Esmtp QQ Mail Server

250 smtp.qq.com

AUTH LOGIN

334 VXNlcm5hbWU6

xxxxxxxxxxxxxxxxxxxx  #隐私内容，经过base64编码的用户名

334 UGFzc3dvcmQ6

xxxxxxxxxxxxxxxxxxx  #隐私内容，经过base64编码的密码

235 Authentication successful

MAIL FROM:492899414@qq.com

250 Ok

RCPT TO:492899414@qq.com

250 Ok

DATA

354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;

From: Moyu
Subject: Smtp Client implementation
To: 492899414@qq.com
Content-Type: text/html

&lt;h1&gt;HELLO SMTP&lt;/h1&gt;
.


250 Ok: queued as 

QUIT

221 Bye
</code></pre><!-- react-text: 42 -->
<!-- /react-text --><h1 id="代码" data-reactid="43"><a href="#%E4%BB%A3%E7%A0%81" aria-hidden="true" data-reactid="44"><span class="icon icon-link" data-reactid="45"></span></a><!-- react-text: 46 -->代码<!-- /react-text --></h1><!-- react-text: 47 -->
<!-- /react-text --><pre data-reactid="48"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="49"><span class="hljs-keyword" data-reactid="50">var</span><!-- react-text: 51 --> net = <!-- /react-text --><span class="hljs-built_in" data-reactid="52">require</span><!-- react-text: 53 -->(<!-- /react-text --><span class="hljs-string" data-reactid="54">&#x27;net&#x27;</span><!-- react-text: 55 -->);
<!-- /react-text --><span class="hljs-function" data-reactid="56"><span class="hljs-keyword" data-reactid="57">function</span><!-- react-text: 58 --> <!-- /react-text --><span class="hljs-title" data-reactid="59">sendMail</span><!-- react-text: 60 -->(<!-- /react-text --><span class="hljs-params" data-reactid="61">host,user,pwd,to,msg</span><!-- react-text: 62 -->) <!-- /react-text --></span><!-- react-text: 63 -->{
    <!-- /react-text --><span class="hljs-keyword" data-reactid="64">var</span><!-- react-text: 65 --> socket = net.createConnection(<!-- /react-text --><span class="hljs-number" data-reactid="66">25</span><!-- react-text: 67 -->,host);
    <!-- /react-text --><span class="hljs-comment" data-reactid="68">// 发送者用户名与密码需要base64编码发送</span><!-- react-text: 69 -->
    <!-- /react-text --><span class="hljs-keyword" data-reactid="70">var</span><!-- react-text: 71 --> user64 = <!-- /react-text --><span class="hljs-keyword" data-reactid="72">new</span><!-- react-text: 73 --> Buffer(user).toString(<!-- /react-text --><span class="hljs-string" data-reactid="74">&quot;base64&quot;</span><!-- react-text: 75 -->); 
    pwd  = <!-- /react-text --><span class="hljs-keyword" data-reactid="76">new</span><!-- react-text: 77 --> Buffer(pwd ).toString(<!-- /react-text --><span class="hljs-string" data-reactid="78">&quot;base64&quot;</span><!-- react-text: 79 -->); 
    socket.on(<!-- /react-text --><span class="hljs-string" data-reactid="80">&#x27;connect&#x27;</span><!-- react-text: 81 -->,<!-- /react-text --><span class="hljs-function" data-reactid="82"><span class="hljs-keyword" data-reactid="83">function</span><!-- react-text: 84 --> (<!-- /react-text --><span class="hljs-params" data-reactid="85"></span><!-- react-text: 86 -->) <!-- /react-text --></span><!-- react-text: 87 -->{
        <!-- /react-text --><span class="hljs-keyword" data-reactid="88">this</span><!-- react-text: 89 -->.write(<!-- /react-text --><span class="hljs-string" data-reactid="90">&#x27;HELO &#x27;</span><!-- react-text: 91 -->+user+<!-- /react-text --><span class="hljs-string" data-reactid="92">&#x27;\r\n&#x27;</span><!-- react-text: 93 -->);
    });
    <!-- /react-text --><span class="hljs-keyword" data-reactid="94">var</span><!-- react-text: 95 --> wt = net.Socket.prototype.write;
    socket.write = <!-- /react-text --><span class="hljs-function" data-reactid="96"><span class="hljs-keyword" data-reactid="97">function</span><!-- react-text: 98 --> (<!-- /react-text --><span class="hljs-params" data-reactid="99"></span><!-- react-text: 100 -->) <!-- /react-text --></span><!-- react-text: 101 -->{
        <!-- /react-text --><span class="hljs-built_in" data-reactid="102">console</span><!-- react-text: 103 -->.log(<!-- /react-text --><span class="hljs-built_in" data-reactid="104">arguments</span><!-- react-text: 105 -->);
        <!-- /react-text --><span class="hljs-keyword" data-reactid="106">return</span><!-- react-text: 107 --> wt.apply(<!-- /react-text --><span class="hljs-keyword" data-reactid="108">this</span><!-- react-text: 109 -->,<!-- /react-text --><span class="hljs-built_in" data-reactid="110">arguments</span><!-- react-text: 111 -->);
    }

    <!-- /react-text --><span class="hljs-keyword" data-reactid="112">var</span><!-- react-text: 113 --> op = [<!-- /react-text --><span class="hljs-string" data-reactid="114">&#x27;AUTH LOGIN\r\n&#x27;</span><!-- react-text: 115 -->];
    socket.pipe(process.stdout);
    socket.on(<!-- /react-text --><span class="hljs-string" data-reactid="116">&#x27;data&#x27;</span><!-- react-text: 117 -->,<!-- /react-text --><span class="hljs-function" data-reactid="118"><span class="hljs-keyword" data-reactid="119">function</span><!-- react-text: 120 --> (<!-- /react-text --><span class="hljs-params" data-reactid="121">data</span><!-- react-text: 122 -->) <!-- /react-text --></span><!-- react-text: 123 -->{
        data = data.toString();
        <!-- /react-text --><span class="hljs-keyword" data-reactid="124">const</span><!-- react-text: 125 --> code = data.match(<!-- /react-text --><span class="hljs-regexp" data-reactid="126">/^\d{3}/</span><!-- react-text: 127 -->)[<!-- /react-text --><span class="hljs-number" data-reactid="128">0</span><!-- react-text: 129 -->]
        <!-- /react-text --><span class="hljs-keyword" data-reactid="130">switch</span><!-- react-text: 131 --> (code){
            <!-- /react-text --><span class="hljs-keyword" data-reactid="132">case</span><!-- react-text: 133 --> <!-- /react-text --><span class="hljs-string" data-reactid="134">&#x27;250&#x27;</span><!-- react-text: 135 -->:{
                <!-- /react-text --><span class="hljs-keyword" data-reactid="136">var</span><!-- react-text: 137 --> v = op.shift();
                <!-- /react-text --><span class="hljs-keyword" data-reactid="138">if</span><!-- react-text: 139 -->(v===<!-- /react-text --><span class="hljs-string" data-reactid="140">&#x27;AUTH LOGIN\r\n&#x27;</span><!-- react-text: 141 -->){
                    op.push(user64+<!-- /react-text --><span class="hljs-string" data-reactid="142">&#x27;\r\n&#x27;</span><!-- react-text: 143 -->);
                    op.push(pwd+<!-- /react-text --><span class="hljs-string" data-reactid="144">&#x27;\r\n&#x27;</span><!-- react-text: 145 -->);
                }<!-- /react-text --><span class="hljs-keyword" data-reactid="146">else</span><!-- react-text: 147 --> <!-- /react-text --><span class="hljs-keyword" data-reactid="148">if</span><!-- react-text: 149 -->(v===<!-- /react-text --><span class="hljs-string" data-reactid="150">&#x27;RCPT TO:&#x27;</span><!-- react-text: 151 -->+to+<!-- /react-text --><span class="hljs-string" data-reactid="152">&#x27;\r\n&#x27;</span><!-- react-text: 153 -->){
                    op.push(<!-- /react-text --><span class="hljs-string" data-reactid="154">&#x27;DATA\r\n&#x27;</span><!-- react-text: 155 -->);
                    op.push(msg+<!-- /react-text --><span class="hljs-string" data-reactid="156">&#x27;\r\n.\r\n&#x27;</span><!-- react-text: 157 -->);
                }
                socket.write(v);
                <!-- /react-text --><span class="hljs-keyword" data-reactid="158">break</span><!-- react-text: 159 -->;
            }
            <!-- /react-text --><span class="hljs-keyword" data-reactid="160">case</span><!-- react-text: 161 --> <!-- /react-text --><span class="hljs-string" data-reactid="162">&#x27;334&#x27;</span><!-- react-text: 163 -->:{
                <!-- /react-text --><span class="hljs-keyword" data-reactid="164">var</span><!-- react-text: 165 --> v = op.shift();
                socket.write(v);
                <!-- /react-text --><span class="hljs-keyword" data-reactid="166">if</span><!-- react-text: 167 -->(op.length===<!-- /react-text --><span class="hljs-number" data-reactid="168">0</span><!-- react-text: 169 -->) op.push(<!-- /react-text --><span class="hljs-string" data-reactid="170">&#x27;MAIL FROM:&#x27;</span><!-- react-text: 171 -->+user+<!-- /react-text --><span class="hljs-string" data-reactid="172">&#x27;\r\n&#x27;</span><!-- react-text: 173 -->);
                <!-- /react-text --><span class="hljs-keyword" data-reactid="174">break</span><!-- react-text: 175 -->;
            }
            <!-- /react-text --><span class="hljs-keyword" data-reactid="176">case</span><!-- react-text: 177 --> <!-- /react-text --><span class="hljs-string" data-reactid="178">&#x27;235&#x27;</span><!-- react-text: 179 -->: socket.write(op.shift()); op.push(<!-- /react-text --><span class="hljs-string" data-reactid="180">&#x27;RCPT TO:&#x27;</span><!-- react-text: 181 -->+to+<!-- /react-text --><span class="hljs-string" data-reactid="182">&#x27;\r\n&#x27;</span><!-- react-text: 183 -->); <!-- /react-text --><span class="hljs-keyword" data-reactid="184">break</span><!-- react-text: 185 -->;
            <!-- /react-text --><span class="hljs-keyword" data-reactid="186">case</span><!-- react-text: 187 --> <!-- /react-text --><span class="hljs-string" data-reactid="188">&#x27;221&#x27;</span><!-- react-text: 189 -->: socket.end(); <!-- /react-text --><span class="hljs-keyword" data-reactid="190">break</span><!-- react-text: 191 -->;
            <!-- /react-text --><span class="hljs-keyword" data-reactid="192">case</span><!-- react-text: 193 --> <!-- /react-text --><span class="hljs-string" data-reactid="194">&#x27;354&#x27;</span><!-- react-text: 195 -->: socket.write(op.shift()); op.push(<!-- /react-text --><span class="hljs-string" data-reactid="196">&#x27;QUIT&#x27;</span><!-- react-text: 197 -->+<!-- /react-text --><span class="hljs-string" data-reactid="198">&#x27;\r\n&#x27;</span><!-- react-text: 199 -->); <!-- /react-text --><span class="hljs-keyword" data-reactid="200">break</span><!-- react-text: 201 -->;
            <!-- /react-text --><span class="hljs-comment" data-reactid="202">// default : console.log(data);</span><!-- react-text: 203 -->
        }
    })
}<!-- /react-text --></code></pre><!-- react-text: 204 -->
<!-- /react-text --><p data-reactid="205">调用</p><!-- react-text: 206 -->
<!-- /react-text --><pre data-reactid="207"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="208"><!-- react-text: 209 -->sendMail(
    <!-- /react-text --><span class="hljs-string" data-reactid="210">&#x27;smtp.qq.com&#x27;</span><!-- react-text: 211 -->,
    <!-- /react-text --><span class="hljs-string" data-reactid="212">&#x27;492899414@qq.com&#x27;</span><!-- react-text: 213 -->,
    <!-- /react-text --><span class="hljs-string" data-reactid="214">&#x27;xxxxxxx&#x27;</span><!-- react-text: 215 -->,
    <!-- /react-text --><span class="hljs-string" data-reactid="216">&#x27;492899414@qq.com&#x27;</span><!-- react-text: 217 -->,
    <!-- /react-text --><span class="hljs-string" data-reactid="218">&quot;From: Moyu\r\n&quot;</span><!-- react-text: 219 -->+
    <!-- /react-text --><span class="hljs-string" data-reactid="220">&quot;Subject: Smtp Client implementation\r\n&quot;</span><!-- react-text: 221 -->+
    <!-- /react-text --><span class="hljs-string" data-reactid="222">&quot;To: 492899414@qq.com\r\n&quot;</span><!-- react-text: 223 -->+
    <!-- /react-text --><span class="hljs-string" data-reactid="224">&quot;Content-Type: text/html\r\n\r\n&quot;</span><!-- react-text: 225 -->+ <!-- /react-text --><span class="hljs-comment" data-reactid="226">// 两个\r\n作为与正式数据的分割</span><!-- react-text: 227 -->
    <!-- /react-text --><span class="hljs-string" data-reactid="228">&quot;&lt;h1&gt;Hello Moyu&lt;/h1&gt;&quot;</span><!-- react-text: 229 -->
);<!-- /react-text --></code></pre><!-- react-text: 230 -->
<!-- /react-text --><p data-reactid="231">成功运行后，输出结果如下</p><!-- react-text: 232 -->
<!-- /react-text --><pre data-reactid="233"><code data-query="{}" data-lang="data-lang" data-reactid="234">{ &#x27;0&#x27;: &#x27;HELO 492899414@qq.com\r\n&#x27; }
220 smtp.qq.com Esmtp QQ Mail Server
250 smtp.qq.com
{ &#x27;0&#x27;: &#x27;AUTH LOGIN\r\n&#x27; }
334 VXNlcm5hbWU6
{ &#x27;0&#x27;: &#x27;NDkyODk5NDE0QHFxLmNvbQ==\r\n&#x27; }
334 UGFzc3dvcmQ6
{ &#x27;0&#x27;: &#x27;xxxxxxxxxxxxxxx\r\n&#x27; }
235 Authentication successful
{ &#x27;0&#x27;: &#x27;MAIL FROM:492899414@qq.com\r\n&#x27; }
250 Ok
{ &#x27;0&#x27;: &#x27;RCPT TO:492899414@qq.com\r\n&#x27; }
250 Ok
{ &#x27;0&#x27;: &#x27;DATA\r\n&#x27; }
354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;
{ &#x27;0&#x27;: &#x27;From: Moyu\r\nSubject: Smtp Client implementation\r\nTo: 492899414@qq.com\r\nContent-Type: text/html\r\n\r\n&lt;h1&gt;Hello Moyu&lt;/h1&gt;\r\n.\r\n&#x27; }
250 Ok: queued as 
{ &#x27;0&#x27;: &#x27;QUIT\r\n&#x27; }
221 Bye
</code></pre><!-- react-text: 235 -->
<!-- /react-text --><h1 id="总结" data-reactid="236"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" data-reactid="237"><span class="icon icon-link" data-reactid="238"></span></a><!-- react-text: 239 -->总结<!-- /react-text --></h1><!-- react-text: 240 -->
<!-- /react-text --><p data-reactid="241">学习了node的相关网络编程，理解SMTP协议，自己造轮子。</p><!-- react-text: 242 -->
<!-- /react-text --></article></div><div class="gitment-container" data-reactid="243"></div><div class="paginator" data-reactid="244"><a title="「思科模拟器」构建虚拟局域网（VLAN）" class="prev" href="/make-vlan" data-reactid="245">Prev</a><a title="「node网络编程」FTP客户端程序" class="next" href="/node-ftp-client" data-reactid="246">Next</a></div></div></main><footer data-reactid="247"><div class="copyright" data-reactid="248"><p data-reactid="249"><!-- react-text: 250 -->© 2017. Powered By <!-- /react-text --><a href="https://github.com/picidaejs/picidae" data-reactid="251">Picidae</a></p></div></footer></div>
</div>
<script src="/PICIDAE_COMMON.js"></script>
<script src="/PICIDAE_ENTRY.js"></script>
</body>
</html>