<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png" />
    <title> imCuttle </title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
<div id="root">
    <div class="wrap" data-reactroot="" data-reactid="1" data-react-checksum="384010657"><header data-reactid="2"><a class="logo-link" href="/" data-reactid="3"><img src="/favicon.png" data-reactid="4"/></a><ul class="nav nav-list" data-reactid="5"><li class="nav-list-item" data-reactid="6"><a class="nav-list-link" href="/posts/1" data-reactid="7">Posts</a></li></ul></header><main data-reactid="8"><div class="post" data-reactid="9"><article class="post-block" data-reactid="10"><h1 class="post-title" data-reactid="11">利用Hook解决moka邮件通知</h1><div class="post-info" data-reactid="12"><time datetime="2017-01-07T21:48:09+00:00" data-reactid="13">Jan 7, 2017 9:48 PM</time></div></article><div class="post-content" data-reactid="14"><article data-reactid="15"><iframe frameborder="no" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&amp;id=202373&amp;auto=1&amp;height=66" data-reactid="16"></iframe><!-- react-text: 17 -->
<!-- /react-text --><p data-reactid="18"> 就在昨天，有位可爱的学妹说想订阅我的Blog，于是我放弃一天复习tcp的时间，捣鼓出文章更新，发送邮件通知的解决方案。</p><!-- react-text: 19 -->
<!-- /react-text --><p data-reactid="20"><!-- react-text: 21 -->借用了部分Git Hook(钩子)的约定，如：采用脚本文件的形式(用户可以选择自己的脚本语言，<!-- /react-text --><code data-reactid="22">python/nodejs/ruby/bash...</code><!-- react-text: 23 -->)，<!-- /react-text --><code data-reactid="24">pre-action/post-action</code><!-- react-text: 25 -->的命名方式<!-- /react-text --></p><!-- react-text: 26 -->
<!-- /react-text --><p data-reactid="27"><code data-reactid="28">moka</code><!-- react-text: 29 --> ≧1.2.3 支持hook，<!-- /react-text --><code data-reactid="30">moka init</code><!-- react-text: 31 -->后产生的文件夹目录如下<!-- /react-text --></p><!-- react-text: 32 -->
<!-- /react-text --><pre data-reactid="33"><code class="hljs language-sh" data-query="{}" data-lang="sh" data-reactid="34"><!-- react-text: 35 -->moka-blog/
├── moka.config.json <!-- /react-text --><span class="hljs-comment" data-reactid="36"># moka配置，包括全局配置，如deploy，bak信息，主题选择</span><!-- react-text: 37 -->
├── package.json     <!-- /react-text --><span class="hljs-comment" data-reactid="38"># 可以无视</span><!-- react-text: 39 -->
├── <!-- /react-text --><span class="hljs-built_in" data-reactid="40">source</span><!-- react-text: 41 -->/          <!-- /react-text --><span class="hljs-comment" data-reactid="42"># moka g 会将该目录下非`_articles`文件夹放入static</span><!-- react-text: 43 -->
│   ├── _articles/   <!-- /react-text --><span class="hljs-comment" data-reactid="44"># moka g 将`_articles`下的markdown文件解析到static中</span><!-- react-text: 45 -->
│   └── ...
├── static/          <!-- /react-text --><span class="hljs-comment" data-reactid="46"># moka g 产生的最终发布的目录，deploy便是发布该目录</span><!-- react-text: 47 -->
│   └── ...   
├── template/
│   └── article.md   <!-- /react-text --><span class="hljs-comment" data-reactid="48"># moka n 命令产生新文章的模板</span><!-- react-text: 49 -->
├── hooks/           <!-- /react-text --><span class="hljs-comment" data-reactid="50"># 钩子, 注意各个钩子的cwd还是`moka-blog`, 如果pre钩子exit code!=0，将会终止process</span><!-- react-text: 51 -->
│   ├── pre-generate.sample
│   ├── post-generate.sample
│   ├── pre-bak.sample
│   ├── post-bak.sample
│   ├── pre-deploy.sample   <!-- /react-text --><span class="hljs-comment" data-reactid="52"># deploy之前调用，必须executable，去除`.sample`后缀</span><!-- react-text: 53 -->
│   └── post-deploy.sample  <!-- /react-text --><span class="hljs-comment" data-reactid="54"># deploy之后调用</span><!-- react-text: 55 -->
└── themes/          <!-- /react-text --><span class="hljs-comment" data-reactid="56"># moka g 将配置中选中对应的主题 `themeBuild`目录 拷贝到static</span><!-- react-text: 57 -->
     └── moka/       <!-- /react-text --><span class="hljs-comment" data-reactid="58"># 主题文件夹，其中包含theme.config.json, 根据主题要求自行配置</span></code></pre><!-- react-text: 59 -->
<!-- /react-text --><p data-reactid="60"><strong data-reactid="61">注意！ 必须去掉样例脚本的.smaple，并且保证脚本是可执行的文件，才能生效。 </strong></p><!-- react-text: 62 -->
<!-- /react-text --><p data-reactid="63"><strong data-reactid="64"><!-- react-text: 65 -->所有的pre Hook必须保证进程结束的<!-- /react-text --><code data-reactid="66">exit code==0</code><!-- react-text: 67 -->，也就是正常退出，不然后续的操作将会因此终断。<!-- /react-text --></strong></p><!-- react-text: 68 -->
<!-- /react-text --><h2 id="文章更新，发送邮件的实现" data-reactid="69"><a href="#%E6%96%87%E7%AB%A0%E6%9B%B4%E6%96%B0%EF%BC%8C%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6%E7%9A%84%E5%AE%9E%E7%8E%B0" aria-hidden="true" data-reactid="70"><span class="icon icon-link" data-reactid="71"></span></a><!-- react-text: 72 -->文章更新，发送邮件的实现<!-- /react-text --></h2><!-- react-text: 73 -->
<!-- /react-text --><p data-reactid="74"><!-- react-text: 75 -->文章更新，发送邮件一共涉及到3个hook，分别是<!-- /react-text --><code data-reactid="76">pre-generate-&gt;post-generate-&gt;post-deploy</code></p><!-- react-text: 77 -->
<!-- /react-text --><p data-reactid="78"><!-- react-text: 79 -->顾名思义，<!-- /react-text --><code data-reactid="80">pre-generate</code><!-- react-text: 81 -->是在产生<!-- /react-text --><code data-reactid="82">static/</code><!-- react-text: 83 -->文件夹，静态资源之前被调用；<!-- /react-text --><code data-reactid="84">post-generate</code><!-- react-text: 85 -->则是在产生完成之后被调用；<!-- /react-text --><code data-reactid="86">post-deploy</code><!-- react-text: 87 --> 在部署到远程服务器（一般为github）之后触发。<!-- /react-text --></p><!-- react-text: 88 -->
<!-- /react-text --><p data-reactid="89">那么，分别在这三个时刻做什么工作才能完成文章更新发送邮件的功能呢？</p><!-- react-text: 90 -->
<!-- /react-text --><ol data-reactid="91"><!-- react-text: 92 -->
<!-- /react-text --><li data-reactid="93"><code data-reactid="94">pre-generate</code><!-- react-text: 95 -->: 将这时所有文章目录保存在一个临时文件<!-- /react-text --><code data-reactid="96">tmp_pre_generate</code><!-- react-text: 97 -->中<!-- /react-text --></li><!-- react-text: 98 -->
<!-- /react-text --><li data-reactid="99"><code data-reactid="100">generate</code><!-- react-text: 101 -->: <!-- /react-text --><code data-reactid="102">static/</code><!-- react-text: 103 -->文件夹更新<!-- /react-text --></li><!-- react-text: 104 -->
<!-- /react-text --><li data-reactid="105"><code data-reactid="106">post-generate</code><!-- react-text: 107 -->: 将这时所有文章目录读取，与文件<!-- /react-text --><code data-reactid="108">tmp_pre_generate</code><!-- react-text: 109 -->对比，得到新添加的文章，并保存在临时文件<!-- /react-text --><code data-reactid="110">tmp_post_generate</code><!-- react-text: 111 -->中<!-- /react-text --></li><!-- react-text: 112 -->
<!-- /react-text --><li data-reactid="113"><code data-reactid="114">deploy</code><!-- react-text: 115 -->: 部署<!-- /react-text --><code data-reactid="116">static/</code><!-- react-text: 117 -->文件夹内容至远端服务器<!-- /react-text --></li><!-- react-text: 118 -->
<!-- /react-text --><li data-reactid="119"><code data-reactid="120">post-deploy</code><!-- react-text: 121 -->: 判断是否存在<!-- /react-text --><code data-reactid="122">tmp_post_generate</code><!-- react-text: 123 -->，读取<!-- /react-text --><code data-reactid="124">tmp_post_generate</code><!-- react-text: 125 -->，并利用<!-- /react-text --><a href="https://github.com/moyuyc/ftp-smtp/" data-reactid="126"><code data-reactid="127">smtp</code></a><!-- react-text: 128 -->协议发送邮件（利用递归，同步发送邮件操作）, 并且将最新的文章时间与title保存至<!-- /react-text --><code data-reactid="129">tmp_post_deploy</code><!-- react-text: 130 -->，下次读取<!-- /react-text --><code data-reactid="131">tmp_post_deploy</code><!-- react-text: 132 -->，确保时间晚于上次最新的文章。<!-- /react-text --></li><!-- react-text: 133 -->
<!-- /react-text --></ol><!-- react-text: 134 -->
<!-- /react-text --><pre data-reactid="135"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="136"><span class="hljs-function" data-reactid="137"><span class="hljs-keyword" data-reactid="138">function</span><!-- react-text: 139 --> <!-- /react-text --><span class="hljs-title" data-reactid="140">sync</span><!-- react-text: 141 -->(<!-- /react-text --><span class="hljs-params" data-reactid="142">callables</span><!-- react-text: 143 -->) <!-- /react-text --></span><!-- react-text: 144 -->{
    <!-- /react-text --><span class="hljs-keyword" data-reactid="145">if</span><!-- react-text: 146 -->(callables.length==<!-- /react-text --><span class="hljs-number" data-reactid="147">0</span><!-- react-text: 148 -->) {
        <!-- /react-text --><span class="hljs-keyword" data-reactid="149">return</span><!-- react-text: 150 --> <!-- /react-text --><span class="hljs-built_in" data-reactid="151">Promise</span><!-- react-text: 152 -->.resolve();
    }
    <!-- /react-text --><span class="hljs-keyword" data-reactid="153">return</span><!-- react-text: 154 --> callables.shift()()
        .then(<!-- /react-text --><span class="hljs-function" data-reactid="155"><span class="hljs-keyword" data-reactid="156">function</span><!-- react-text: 157 -->(<!-- /react-text --><span class="hljs-params" data-reactid="158">x</span><!-- react-text: 159 -->) <!-- /react-text --></span><!-- react-text: 160 -->{
            <!-- /react-text --><span class="hljs-keyword" data-reactid="161">return</span><!-- react-text: 162 --> sync(callables);
        })
}<!-- /react-text --></code></pre><!-- react-text: 163 -->
<!-- /react-text --><h2 id="小结" data-reactid="164"><a href="#%E5%B0%8F%E7%BB%93" aria-hidden="true" data-reactid="165"><span class="icon icon-link" data-reactid="166"></span></a><!-- react-text: 167 -->小结<!-- /react-text --></h2><!-- react-text: 168 -->
<!-- /react-text --><ol data-reactid="169"><!-- react-text: 170 -->
<!-- /react-text --><li data-reactid="171"><!-- react-text: 172 -->在<!-- /react-text --><code data-reactid="173">osx shell</code><!-- react-text: 174 -->环境中，<!-- /react-text --><code data-reactid="175">#!/usr/bin/env node</code><!-- react-text: 176 -->该脚本头可以正常运行，但在<!-- /react-text --><code data-reactid="177">osx moka-desktop</code><!-- react-text: 178 -->中不能生效，改成<!-- /react-text --><code data-reactid="179">#!/usr/local/bin/node</code><!-- react-text: 180 -->即可<!-- /react-text --></li><!-- react-text: 181 -->
<!-- /react-text --><li data-reactid="182">配合hooks，同学们还可以完成更多有趣的功能。</li><!-- react-text: 183 -->
<!-- /react-text --></ol><!-- react-text: 184 -->
<!-- /react-text --></article></div><div class="gitment-container" data-reactid="185"></div><div class="paginator" data-reactid="186"><a title="JavaScript正则填坑记" class="prev" href="/record-once-javascript-regexp-landfill" data-reactid="187">Prev</a><a title="React Native 意识流" class="next" href="/react-native-starter" data-reactid="188">Next</a></div></div></main><footer data-reactid="189"><div class="copyright" data-reactid="190"><p data-reactid="191"><!-- react-text: 192 -->© 2017. Powered By <!-- /react-text --><a href="https://github.com/picidaejs/picidae" data-reactid="193">Picidae</a></p></div></footer></div>
</div>
<script src="/PICIDAE_COMMON.js"></script>
<script src="/PICIDAE_ENTRY.js"></script>
</body>
</html>